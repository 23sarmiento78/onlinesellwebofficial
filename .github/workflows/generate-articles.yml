name: ğŸ¤– GeneraciÃ³n AutomÃ¡tica de ArtÃ­culos

on:
  # Ejecutar todos los dÃ­as a las 16:00 Argentina (19:00 UTC)
  schedule:
    - cron: '0 19 * * *'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      article_count:
        description: 'NÃºmero de artÃ­culos a generar'
        required: false
        default: '3'
        type: string

jobs:
  generate-articles:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ğŸ”„ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ“… Configurar zona horaria Argentina
        run: |
          sudo timedatectl set-timezone America/Argentina/Buenos_Aires
          echo "Hora actual en Argentina: $(date)"

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependencias
        run: |
          # Limpiar cache y node_modules si existe
          rm -rf node_modules package-lock.json || true
          
          # Instalar dependencias
          npm install
          
          # Instalar dependencias especÃ­ficas si no estÃ¡n
          npm install glob @google/generative-ai

      - name: ğŸ§ª Verificar configuraciÃ³n
        run: |
          echo "ğŸ”§ Verificando configuraciÃ³n del sistema..."
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "GEMINI_API_KEY configurada: ${{ secrets.GEMINI_API_KEY != '' }}"
          echo "Directorio actual: $(pwd)"
          ls -la scripts/ || echo "Directorio scripts no encontrado"
          
          # Verificar que las dependencias crÃ­ticas estÃ©n instaladas
          echo "ğŸ“¦ Verificando dependencias crÃ­ticas..."
          node -e "console.log('âœ… @google/generative-ai:', require('@google/generative-ai').version || 'instalado')" || echo "âŒ @google/generative-ai no disponible"
          node -e "console.log('âœ… glob:', require('glob').version || 'instalado')" || echo "âŒ glob no disponible"

      - name: ğŸš€ Generar artÃ­culos automÃ¡ticamente
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ vars.SITE_URL || 'https://hgaruna.org' }}
          ARTICLE_COUNT: ${{ github.event.inputs.article_count || '3' }}
        run: |
          echo "ğŸ¯ Iniciando generaciÃ³n de $ARTICLE_COUNT artÃ­culos..."
          echo "ğŸ“… Fecha: $(date '+%Y-%m-%d %H:%M:%S %Z')"

          # Ejecutar el script de generaciÃ³n automÃ¡tica
          # El script ahora maneja errores de cuota y siempre retorna exit code 0
          node scripts/github-action-article-generator.js

          echo "âœ… GeneraciÃ³n completada (con manejo de errores mejorado)"

      - name: ğŸ“‹ Actualizar Ã­ndice del blog
        run: |
          echo "ğŸ“‹ Actualizando Ã­ndice del blog..."
          node scripts/auto-regenerate-blog-index.cjs || echo "âš ï¸ Error actualizando Ã­ndice, continuando..."
          echo "âœ… Ãndice del blog actualizado"

      - name: ğŸ—ºï¸ Actualizar sitemap
        run: |
          echo "ğŸ—ºï¸ Generando sitemap actualizado..."
          node scripts/generate-sitemap.js || echo "âš ï¸ Error generando sitemap, continuando..."
          echo "âœ… Sitemap actualizado"

      - name: ğŸ” Verificar integraciÃ³n
        run: |
          echo "ğŸ” Verificando que todo estÃ© correctamente integrado..."
          node scripts/verify-integration.js || echo "âš ï¸ Error en verificaciÃ³n, continuando..."
          echo "âœ… IntegraciÃ³n verificada"

      - name: ğŸ“Š Generar resumen
        run: |
          echo "ğŸ“‹ Generando resumen de cambios..."
          
          # Contar archivos nuevos
          NEW_ARTICLES=$(git diff --name-only --diff-filter=A | grep -E "\.(html|md)$" | wc -l)
          MODIFIED_FILES=$(git diff --name-only --diff-filter=M | wc -l)
          
          echo "ğŸ“ ArtÃ­culos nuevos: $NEW_ARTICLES"
          echo "ğŸ”§ Archivos modificados: $MODIFIED_FILES"
          
          # Crear resumen para el commit
          cat > commit_summary.txt << EOF
          ğŸ¤– GeneraciÃ³n automÃ¡tica de artÃ­culos - $(date '+%Y-%m-%d')
          
          ğŸ“Š Resumen:
          - ğŸ“ ArtÃ­culos nuevos: $NEW_ARTICLES
          - ğŸ”§ Archivos modificados: $MODIFIED_FILES
          - ğŸ• Generado: $(date '+%Y-%m-%d %H:%M:%S %Z')
          - ğŸ¤– Proceso: GitHub Actions automÃ¡tico
          
          ğŸ¯ Optimizado para Google AdSense
          ğŸ” SEO local Villa Carlos Paz
          âœ¨ Contenido generado con IA
          EOF

      - name: ğŸ” Verificar cambios
        id: verify_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Se detectaron cambios en el repositorio"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No se detectaron cambios"
          fi

      - name: ğŸ“¤ Commit y push automÃ¡tico
        if: steps.verify_changes.outputs.has_changes == 'true'
        run: |
          # Configurar Git
          git config --local user.email "action@github.com"
          git config --local user.name "hgaruna Bot"
          
          # AÃ±adir todos los cambios
          git add .
          
          # Crear commit con resumen detallado
          git commit -F commit_summary.txt || echo "âš ï¸ No hay cambios para commitear"
          
          # Push a la rama principal
          git push origin HEAD:main || echo "âš ï¸ Error en push, pero continuando..."
          
          echo "âœ… Cambios enviados exitosamente"

      - name: ğŸ“ˆ Actualizar estadÃ­sticas
        if: steps.verify_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“Š Actualizando estadÃ­sticas del sistema..."
          
          # Contar total de artÃ­culos
          TOTAL_ARTICLES=$(find public/blog -name "*.html" | wc -l)
          
          # Crear badge de estadÃ­sticas
          curl -X POST "https://img.shields.io/badge/Art%C3%ADculos-$TOTAL_ARTICLES-brightgreen" > /dev/null 2>&1 || true
          
          echo "ğŸ“Š Total de artÃ­culos en el sitio: $TOTAL_ARTICLES"

      - name: ğŸ”” NotificaciÃ³n de Ã©xito
        if: steps.verify_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ‰ Â¡GeneraciÃ³n de artÃ­culos completada exitosamente!"
          echo "ğŸ“… Fecha: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ”— Los cambios estÃ¡n disponibles en el repositorio"

      - name: âš ï¸ NotificaciÃ³n de fallo
        if: failure()
        run: |
          echo "âŒ Error en la generaciÃ³n de artÃ­culos"
          echo "ğŸ“… Fecha: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ” Revisa los logs para mÃ¡s detalles"

      - name: ğŸ“‹ Crear issue en caso de fallo
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âŒ Fallo en generaciÃ³n automÃ¡tica de artÃ­culos - ${new Date().toISOString().split('T')[0]}`,
              body: `
              ## ğŸš¨ Error en GeneraciÃ³n AutomÃ¡tica
              
              **Fecha:** ${new Date().toLocaleString('es-AR', {timeZone: 'America/Argentina/Buenos_Aires'})}
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              
              ### ğŸ” Detalles
              La generaciÃ³n automÃ¡tica de artÃ­culos fallÃ³. Revisar logs del workflow para mÃ¡s informaciÃ³n.
              
              ### ğŸ› ï¸ Acciones Sugeridas
              - [ ] Verificar configuraciÃ³n de GEMINI_API_KEY
              - [ ] Revisar logs del workflow
              - [ ] Ejecutar manualmente para debug
              - [ ] Verificar dependencias y scripts
              
              **Enlaces Ãºtiles:**
              - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
              - [Repository](${context.payload.repository.html_url})
              `,
              labels: ['bug', 'automation', 'github-actions']
            })

  # Job separado para estadÃ­sticas diarias
  daily-stats:
    runs-on: ubuntu-latest
    needs: generate-articles
    if: always()
    
    steps:
      - name: ğŸ“Š Generar estadÃ­sticas diarias
        run: |
          echo "ğŸ“ˆ EstadÃ­sticas de hoy $(date '+%Y-%m-%d'):"
          echo "ğŸ¤– Workflow ejecutado a las $(date '+%H:%M %Z')"
          echo "âœ… Sistema de generaciÃ³n automÃ¡tica activo"
