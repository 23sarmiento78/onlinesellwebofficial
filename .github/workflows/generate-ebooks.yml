name: Generar Ebooks desde Artículos

on:
  schedule:
    # Generar ebooks una vez por semana los domingos a las 10:00 AM (hora Argentina)
    # cron: 'minuto hora día mes día_semana'
    - cron: '0 13 * * 0'
  workflow_dispatch:
  # También se puede ejecutar manualmente desde GitHub

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generar-ebooks:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Clonar repositorio
        uses: actions/checkout@v4

      - name: 🔧 Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ⚙️ Cache de dependencias de Node
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: 📦 Instalar dependencias
        run: npm install

      - name: ⚙️ Configurar variables de entorno
        env:
          SITE_URL: https://www.hgaruna.org
        run: echo "SITE_URL=$SITE_URL" >> $GITHUB_ENV

      - name: 📚 Generar todos los tipos de ebooks (semanal)
        env:
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          echo "📚 Generando ebooks (ejecución semanal)..."
          echo "📅 Fecha de ejecución: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "--- Generando ebooks básicos ---"
          npm run generate-ebooks
          echo "--- Generando ebooks avanzados ---"
          npm run generate-advanced-ebooks
          echo "--- Generando ebooks con estilos modulares ---"
          npm run generate-styled-ebooks

      - name: 📚 Combinar y mejorar ebooks en un PDF final
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/combine-ebooks.js

      - name: 📊 Verificar ebooks generados
        run: |
          echo "📁 Contenido del directorio ebooks:"
          ls -la ebooks/ || echo "⚠️ Directorio ebooks no encontrado"

          if [ -d "ebooks" ]; then
            echo "📄 Archivos generados:"
            find ebooks/ -name "*.pdf" -o -name "*.html" | head -20

            echo "📊 Estadísticas de archivos:"
            echo "PDFs: $(find ebooks/ -name "*.pdf" | wc -l)"
            echo "HTMLs: $(find ebooks/ -name "*.html" | wc -l)"
          fi

      - name: 💾 Commit y push de ebooks y guía combinada
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ebooks/
          git commit -m "[bot] Actualización semanal de ebooks y guía combinada ($(date '+%Y-%m-%d'))" || echo "No hay cambios para commitear"
          git push || echo "Nada para pushear"

      - name: 📢 Notificación de éxito
        if: success()
        run: |
          echo "✅ Ebooks generados exitosamente"
          echo "📁 Los ebooks se encuentran en: ebooks/"
          echo "📄 Archivos generados:"
          find ebooks/ -name "*.pdf" -o -name "*.html" 2>/dev/null | head -10

      - name: ❌ Notificación de error
        if: failure()
        run: |
          echo "❌ Error en la generación de ebooks"
          echo "🔍 Revisar logs para más detalles" 