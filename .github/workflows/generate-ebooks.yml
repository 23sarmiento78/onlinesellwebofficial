name: Generar Ebooks desde ArtÃ­culos

on:
  schedule:
    # Generar ebooks una vez por semana los domingos a las 10:00 AM (hora Argentina)
    # cron: 'minuto hora dÃ­a mes dÃ­a_semana'
    - cron: '0 13 * * 0'
  workflow_dispatch:
  # TambiÃ©n se puede ejecutar manualmente desde GitHub

jobs:
  generar-ebooks:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: ğŸ”§ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Instalar dependencias
        run: npm install

      - name: âš™ï¸ Configurar variables de entorno
        env:
          SITE_URL: https://www.hgaruna.org
        run: echo "SITE_URL=$SITE_URL" >> $GITHUB_ENV

      - name: ğŸ“š Generar ebooks bÃ¡sicos (semanal)
        env:
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          echo "ğŸ“š Generando ebooks bÃ¡sicos (ejecuciÃ³n semanal)..."
          echo "ğŸ“… Fecha de ejecuciÃ³n: $(date '+%Y-%m-%d %H:%M:%S')"
          npm run generate-ebooks

      - name: ğŸ“š Generar ebooks avanzados (semanal)
        env:
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          echo "ğŸ“š Generando ebooks avanzados (ejecuciÃ³n semanal)..."
          echo "ğŸ“… Fecha de ejecuciÃ³n: $(date '+%Y-%m-%d %H:%M:%S')"
          npm run generate-advanced-ebooks

      - name: ğŸ¨ Generar ebooks con estilos modulares (semanal)
        env:
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          echo "ğŸ¨ Generando ebooks con estilos modulares (ejecuciÃ³n semanal)..."
          echo "ğŸ“… Fecha de ejecuciÃ³n: $(date '+%Y-%m-%d %H:%M:%S')"
          npm run generate-styled-ebooks

      - name: ğŸ“Š Verificar ebooks generados
        run: |
          echo "ğŸ“ Contenido del directorio ebooks:"
          ls -la ebooks/ || echo "âš ï¸ Directorio ebooks no encontrado"
          
          if [ -d "ebooks" ]; then
            echo "ğŸ“„ Archivos generados:"
            find ebooks/ -name "*.pdf" -o -name "*.html" | head -20
            
            echo "ğŸ“Š EstadÃ­sticas de archivos:"
            echo "PDFs: $(find ebooks/ -name "*.pdf" | wc -l)"
            echo "HTMLs: $(find ebooks/ -name "*.html" | wc -l)"
          fi

      - name: ğŸ’¾ Commit y push de ebooks
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Agregar solo archivos de ebooks
          git add ebooks/ || echo "No hay archivos de ebooks para agregar"
          
          # Commit con informaciÃ³n detallada (ejecuciÃ³n semanal)
          if git diff --cached --quiet; then
            echo "No hay cambios para commitear"
          else
            EBOOK_COUNT=$(find ebooks/ -name "*.pdf" 2>/dev/null | wc -l)
            git commit -m "[bot] Ebooks generados semanalmente - $(date '+%Y-%m-%d %H:%M:%S') ART - Se generaron $EBOOK_COUNT ebooks (ejecuciÃ³n semanal)" || echo "Nada para commitear"
            
            git push || echo "Nada para pushear"
          fi

      - name: ğŸ“¢ NotificaciÃ³n de Ã©xito
        if: success()
        run: |
          echo "âœ… Ebooks generados exitosamente"
          echo "ğŸ“ Los ebooks se encuentran en: ebooks/"
          echo "ğŸ“„ Archivos generados:"
          find ebooks/ -name "*.pdf" -o -name "*.html" 2>/dev/null | head -10

      - name: âŒ NotificaciÃ³n de error
        if: failure()
        run: |
          echo "âŒ Error en la generaciÃ³n de ebooks"
          echo "ğŸ” Revisar logs para mÃ¡s detalles" 