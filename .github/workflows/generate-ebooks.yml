name: ğŸ“š Sistema Avanzado de GeneraciÃ³n de Ebooks

on:
  schedule:
    # GeneraciÃ³n semanal optimizada los domingos a las 8:00 AM (Argentina UTC-3)
    - cron: '0 11 * * 0'
  workflow_dispatch:
    inputs:
      ebook_types:
        description: 'Tipos de ebooks a generar'
        required: false
        default: 'all'
        type: choice
        options:
          - basic
          - advanced
          - styled
          - all
      quality_level:
        description: 'Nivel de calidad'
        required: false
        default: 'premium'
        type: choice
        options:
          - standard
          - premium
          - enterprise
      generate_pdfs:
        description: 'Generar versiones PDF'
        required: false
        default: true
        type: boolean

env:
  SITE_URL: https://hgaruna.org
  NODEJS_VERSION: '20'
  EBOOK_TYPES: ${{ github.event.inputs.ebook_types || 'all' }}
  QUALITY_LEVEL: ${{ github.event.inputs.quality_level || 'premium' }}
  GENERATE_PDFS: ${{ github.event.inputs.generate_pdfs || 'true' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-content:
    name: ğŸ“Š AnÃ¡lisis de Contenido
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    outputs:
      articles-available: ${{ steps.content-analysis.outputs.articles-count }}
      categories-found: ${{ steps.content-analysis.outputs.categories }}
      content-quality: ${{ steps.content-analysis.outputs.quality-score }}
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ§  Setup Node.js con Cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
          cache: 'npm'

      - name: âš¡ InstalaciÃ³n de Dependencias
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          npm install puppeteer-core chromium --save-dev

      - name: ğŸ“Š AnÃ¡lisis Profundo de Contenido
        id: content-analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ“Š Analizando contenido disponible..."
          
          # Ejecutar anÃ¡lisis inteligente
          ANALYSIS_RESULT=$(node scripts/advanced-content-analyzer.js)
          
          # Extraer mÃ©tricas
          ARTICLES_COUNT=$(echo "$ANALYSIS_RESULT" | grep "articles_count:" | cut -d':' -f2)
          CATEGORIES=$(echo "$ANALYSIS_RESULT" | grep "categories:" | cut -d':' -f2)
          QUALITY_SCORE=$(echo "$ANALYSIS_RESULT" | grep "quality_score:" | cut -d':' -f2)
          
          echo "articles-count=${ARTICLES_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "categories=${CATEGORIES:-unknown}" >> $GITHUB_OUTPUT
          echo "quality-score=${QUALITY_SCORE:-0}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š AnÃ¡lisis completado: $ARTICLES_COUNT artÃ­culos, Score: $QUALITY_SCORE"

  generate-ebooks:
    name: ğŸ“š GeneraciÃ³n de Ebooks
    needs: analyze-content
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        type: [basic, advanced, styled]
        
    outputs:
      ebooks-generated: ${{ steps.generate.outputs.count }}
      file-sizes: ${{ steps.generate.outputs.sizes }}
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§  Setup Node.js con Cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ InstalaciÃ³n de Dependencias Avanzadas
        run: |
          npm ci --prefer-offline
          
          # Instalar dependencias para PDF
          if [ "${{ env.GENERATE_PDFS }}" = "true" ]; then
            npm install puppeteer-core
            apt-get update && apt-get install -y chromium-browser
          fi

      - name: ğŸ¨ Setup de Plantillas y Estilos
        run: |
          echo "ğŸ¨ Configurando plantillas..."
          
          # Crear directorio de plantillas si no existe
          mkdir -p templates/ebooks
          
          # Copiar plantillas base
          node scripts/setup-ebook-templates.js --type=${{ matrix.type }} --quality=${{ env.QUALITY_LEVEL }}

      - name: ğŸ“š GeneraciÃ³n de Ebooks por Tipo
        id: generate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ env.SITE_URL }}
          EBOOK_TYPE: ${{ matrix.type }}
          QUALITY_LEVEL: ${{ env.QUALITY_LEVEL }}
          ARTICLES_AVAILABLE: ${{ needs.analyze-content.outputs.articles-available }}
        run: |
          echo "ğŸ“š Generando ebooks tipo: ${{ matrix.type }}"
          
          # Generar ebook con configuraciÃ³n especÃ­fica
          GENERATION_RESULT=$(node scripts/intelligent-ebook-generator.js \
            --type=${{ matrix.type }} \
            --quality=${{ env.QUALITY_LEVEL }} \
            --articles=${{ needs.analyze-content.outputs.articles-available }})
          
          # Extraer resultados
          EBOOKS_COUNT=$(echo "$GENERATION_RESULT" | grep "ebooks_generated:" | cut -d':' -f2)
          FILE_SIZES=$(echo "$GENERATION_RESULT" | grep "file_sizes:" | cut -d':' -f2)
          
          echo "count=${EBOOKS_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "sizes=${FILE_SIZES:-unknown}" >> $GITHUB_OUTPUT
          
          echo "âœ… Generados $EBOOKS_COUNT ebooks tipo ${{ matrix.type }}"

      - name: ğŸ” ValidaciÃ³n de Calidad
        run: |
          echo "ğŸ” Validando calidad de ebooks generados..."
          
          # Verificar que los archivos existen y tienen contenido
          for file in ebooks/*.html; do
            if [ -f "$file" ]; then
              FILE_SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
              if [ "$FILE_SIZE" -lt 1000 ]; then
                echo "âŒ Error: $file es demasiado pequeÃ±o ($FILE_SIZE bytes)"
                exit 1
              fi
              echo "âœ… $file: $FILE_SIZE bytes"
            fi
          done

      - name: ğŸ“„ GeneraciÃ³n de PDFs (Opcional)
        if: env.GENERATE_PDFS == 'true'
        run: |
          echo "ğŸ“„ Generando versiones PDF..."
          
          # Generar PDFs con alta calidad
          node scripts/advanced-pdf-generator.js \
            --input-dir=ebooks \
            --output-dir=ebooks/pdf \
            --quality=${{ env.QUALITY_LEVEL }}

      - name: ğŸ“Š AnÃ¡lisis de MÃ©tricas
        id: metrics
        run: |
          echo "ğŸ“Š Calculando mÃ©tricas..."
          
          # Calcular estadÃ­sticas
          HTML_COUNT=$(find ebooks -name "*.html" | wc -l)
          PDF_COUNT=$(find ebooks -name "*.pdf" 2>/dev/null | wc -l || echo "0")
          TOTAL_SIZE=$(du -sh ebooks/ | cut -f1)
          
          echo "html-count=$HTML_COUNT" >> $GITHUB_OUTPUT
          echo "pdf-count=$PDF_COUNT" >> $GITHUB_OUTPUT
          echo "total-size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š MÃ©tricas: $HTML_COUNT HTML, $PDF_COUNT PDF, TamaÃ±o: $TOTAL_SIZE"

      - name: ğŸ’¾ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ebooks-${{ matrix.type }}-${{ env.QUALITY_LEVEL }}
          path: ebooks/
          retention-days: 30

  combine-and-optimize:
    name: ğŸ¯ CombinaciÃ³n y OptimizaciÃ³n
    needs: [analyze-content, generate-ebooks]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ InstalaciÃ³n de Dependencias
        run: npm ci --prefer-offline

      - name: ğŸ“š Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: temp-ebooks/

      - name: ğŸ¯ CombinaciÃ³n Inteligente de Ebooks
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          QUALITY_LEVEL: ${{ env.QUALITY_LEVEL }}
        run: |
          echo "ğŸ¯ Combinando ebooks de forma inteligente..."
          
          # Mover archivos descargados
          mkdir -p ebooks
          cp -r temp-ebooks/*/* ebooks/ 2>/dev/null || true
          
          # Ejecutar combinaciÃ³n avanzada
          node scripts/intelligent-ebook-combiner.js \
            --quality=${{ env.QUALITY_LEVEL }} \
            --articles-available=${{ needs.analyze-content.outputs.articles-available }}

      - name: ğŸ“Š OptimizaciÃ³n de Ebooks
        run: |
          echo "ğŸ“Š Optimizando ebooks..."
          
          # Optimizar HTML
          node scripts/ebook-optimizer.js --type=html
          
          # Optimizar imÃ¡genes si existen
          if [ -d "ebooks/images" ]; then
            node scripts/ebook-optimizer.js --type=images
          fi

      - name: ğŸ” GeneraciÃ³n de Ãndice y Metadatos
        run: |
          echo "ğŸ” Generando Ã­ndice y metadatos..."
          
          # Generar Ã­ndice maestro
          node scripts/generate-ebook-index.js
          
          # Generar metadatos
          node scripts/generate-ebook-metadata.js

      - name: ğŸ’¾ Commit Final
        run: |
          git config --global user.name 'hgaruna-bot[EBOOKS]'
          git config --global user.email 'bot+ebooks@hgaruna.org'
          
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          EBOOK_COUNT=$(find ebooks -name "*.html" | wc -l)
          PDF_COUNT=$(find ebooks -name "*.pdf" 2>/dev/null | wc -l || echo "0")
          
          COMMIT_MSG="ğŸ“š ActualizaciÃ³n semanal de ebooks optimizados
          
          ğŸ“Š EstadÃ­sticas:
          - Ebooks HTML: $EBOOK_COUNT
          - Ebooks PDF: $PDF_COUNT
          - Calidad: ${{ env.QUALITY_LEVEL }}
          - ArtÃ­culos procesados: ${{ needs.analyze-content.outputs.articles-available }}
          - Score de contenido: ${{ needs.analyze-content.outputs.content-quality }}/100
          
          ğŸ¯ CaracterÃ­sticas:
          - GeneraciÃ³n inteligente con Gemini
          - OptimizaciÃ³n automÃ¡tica de contenido
          - Ãndice maestro actualizado
          - Metadatos enriquecidos
          - Plantillas responsivas
          
          â° Generado: $TIMESTAMP
          
          #Ebooks #ContentGeneration #AutomatedPublishing"
          
          git add ebooks/
          
          if git diff --staged --quiet; then
            echo "ğŸ“ No hay cambios para commitear"
          else
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… Ebooks actualizados y pusheados"
          fi

      - name: ğŸ“Š Reporte Final
        run: |
          echo "## ğŸ“š Reporte de GeneraciÃ³n de Ebooks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ MÃ©tricas de GeneraciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "- **ArtÃ­culos disponibles**: ${{ needs.analyze-content.outputs.articles-available }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CategorÃ­as encontradas**: ${{ needs.analyze-content.outputs.categories }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Score de calidad**: ${{ needs.analyze-content.outputs.content-quality }}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **Nivel de calidad**: ${{ env.QUALITY_LEVEL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Archivos Generados" >> $GITHUB_STEP_SUMMARY
          EBOOK_COUNT=$(find ebooks -name "*.html" | wc -l)
          PDF_COUNT=$(find ebooks -name "*.pdf" 2>/dev/null | wc -l || echo "0")
          TOTAL_SIZE=$(du -sh ebooks/ 2>/dev/null | cut -f1 || echo "N/A")
          echo "- **Ebooks HTML**: $EBOOK_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Ebooks PDF**: $PDF_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **TamaÃ±o total**: $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Estado del Proceso" >> $GITHUB_STEP_SUMMARY
          echo "- **Tipos generados**: ${{ env.EBOOK_TYPES }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PDFs habilitados**: ${{ env.GENERATE_PDFS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OptimizaciÃ³n aplicada**: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: ğŸ§¹ Limpieza
    needs: [analyze-content, generate-ebooks, combine-and-optimize]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ§¹ Cleanup Temporal Files
        run: |
          echo "ğŸ§¹ Limpiando archivos temporales..."
          # La limpieza se maneja automÃ¡ticamente por GitHub Actions
          echo "âœ… Limpieza completada"

      - name: ğŸ“Š Reporte de Estado Final
        if: always()
        run: |
          echo "ğŸ“Š Estado final del workflow:"
          echo "- AnÃ¡lisis: ${{ needs.analyze-content.result }}"
          echo "- GeneraciÃ³n: ${{ needs.generate-ebooks.result }}"
          echo "- CombinaciÃ³n: ${{ needs.combine-and-optimize.result }}"
          
          if [ "${{ needs.combine-and-optimize.result }}" = "success" ]; then
            echo "âœ… Workflow completado exitosamente"
          else
            echo "âŒ Workflow completado con errores"
          fi
