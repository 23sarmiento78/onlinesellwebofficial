name: Generar Ebooks desde ArtÃ­culos

on:
  schedule:
    # Generar ebooks una vez por semana los domingos a las 10:00 AM (hora Argentina)
    # cron: 'minuto hora dÃ­a mes dÃ­a_semana'
    - cron: '0 13 * * 0'
  workflow_dispatch:
  # TambiÃ©n se puede ejecutar manualmente desde GitHub

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generar-ebooks:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: ğŸ”§ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âš™ï¸ Cache de dependencias de Node
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ“¦ Instalar dependencias
        run: npm install

      - name: âš™ï¸ Configurar variables de entorno
        env:
          SITE_URL: https://www.hgaruna.org
        run: echo "SITE_URL=$SITE_URL" >> $GITHUB_ENV

      - name: ğŸ“š Generar todos los tipos de ebooks (semanal)
        env:
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          echo "ğŸ“š Generando ebooks (ejecuciÃ³n semanal)..."
          echo "ğŸ“… Fecha de ejecuciÃ³n: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "--- Generando ebooks bÃ¡sicos ---"
          npm run generate-ebooks
          echo "--- Generando ebooks avanzados ---"
          npm run generate-advanced-ebooks
          echo "--- Generando ebooks con estilos modulares ---"
          npm run generate-styled-ebooks

      - name: ğŸ“š Combinar y mejorar ebooks en un PDF final
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/combine-ebooks.js

      - name: ğŸ“Š Verificar ebooks generados
        run: |
          echo "ğŸ“ Contenido del directorio ebooks:"
          ls -la ebooks/ || echo "âš ï¸ Directorio ebooks no encontrado"

          if [ -d "ebooks" ]; then
            echo "ğŸ“„ Archivos generados:"
            find ebooks/ -name "*.pdf" -o -name "*.html" | head -20

            echo "ğŸ“Š EstadÃ­sticas de archivos:"
            echo "PDFs: $(find ebooks/ -name "*.pdf" | wc -l)"
            echo "HTMLs: $(find ebooks/ -name "*.html" | wc -l)"
          fi

      - name: ğŸ’¾ Commit y push de ebooks y guÃ­a combinada
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ebooks/
          git commit -m "[bot] ActualizaciÃ³n semanal de ebooks y guÃ­a combinada ($(date '+%Y-%m-%d'))" || echo "No hay cambios para commitear"
          git push || echo "Nada para pushear"

      - name: ğŸ“¢ NotificaciÃ³n de Ã©xito
        if: success()
        run: |
          echo "âœ… Ebooks generados exitosamente"
          echo "ğŸ“ Los ebooks se encuentran en: ebooks/"
          echo "ğŸ“„ Archivos generados:"
          find ebooks/ -name "*.pdf" -o -name "*.html" 2>/dev/null | head -10

      - name: âŒ NotificaciÃ³n de error
        if: failure()
        run: |
          echo "âŒ Error en la generaciÃ³n de ebooks"
          echo "ğŸ” Revisar logs para mÃ¡s detalles" 