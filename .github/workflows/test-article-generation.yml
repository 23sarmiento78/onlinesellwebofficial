name: ğŸ§ª Test - GeneraciÃ³n de ArtÃ­culos

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Modo de prueba'
        required: true
        default: 'single'
        type: choice
        options:
        - single
        - multiple
        - full_system
      
      article_count:
        description: 'NÃºmero de artÃ­culos (para modo multiple)'
        required: false
        default: '1'
        type: string
      
      test_topic:
        description: 'Tema especÃ­fico para test (opcional)'
        required: false
        default: ''
        type: string

jobs:
  test-generation:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: ğŸ”„ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependencias
        run: |
          npm ci
          npm install glob @google/generative-ai

      - name: ğŸ§ª Test - ArtÃ­culo individual
        if: ${{ github.event.inputs.test_mode == 'single' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ vars.SITE_URL || 'https://hgaruna.org' }}
          ARTICLE_COUNT: 1
        run: |
          echo "ğŸ§ª Ejecutando test de artÃ­culo individual..."
          node scripts/github-action-article-generator.js

      - name: ğŸ§ª Test - MÃºltiples artÃ­culos
        if: ${{ github.event.inputs.test_mode == 'multiple' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ vars.SITE_URL || 'https://hgaruna.org' }}
          ARTICLE_COUNT: ${{ github.event.inputs.article_count }}
        run: |
          echo "ğŸ§ª Ejecutando test de mÃºltiples artÃ­culos..."
          echo "ğŸ“Š Cantidad: $ARTICLE_COUNT"
          node scripts/github-action-article-generator.js

      - name: ğŸ§ª Test - Sistema completo
        if: ${{ github.event.inputs.test_mode == 'full_system' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ vars.SITE_URL || 'https://hgaruna.org' }}
        run: |
          echo "ğŸ§ª Ejecutando test del sistema completo..."
          node run-adsense-system.js --test --full

      - name: ğŸ“Š Verificar resultados
        run: |
          echo "ğŸ“‹ Verificando archivos generados..."
          
          # Contar archivos generados
          NEW_HTML=$(find public/blog -name "*.html" -newer .git/HEAD 2>/dev/null | wc -l)
          NEW_MD=$(find src/content/articles -name "*.md" -newer .git/HEAD 2>/dev/null | wc -l)
          
          echo "ğŸ“„ Archivos HTML nuevos: $NEW_HTML"
          echo "ğŸ“ Archivos MD nuevos: $NEW_MD"
          
          # Listar archivos recientes
          if [ $NEW_HTML -gt 0 ]; then
            echo "ğŸ“ Archivos HTML generados:"
            find public/blog -name "*.html" -newer .git/HEAD 2>/dev/null | head -10
          fi
          
          if [ $NEW_MD -gt 0 ]; then
            echo "ğŸ“ Archivos MD generados:"
            find src/content/articles -name "*.md" -newer .git/HEAD 2>/dev/null | head -10
          fi

      - name: ğŸ“ˆ Analizar calidad
        run: |
          echo "ğŸ” Analizando calidad de contenido generado..."
          
          # Verificar que los archivos no estÃ¡n vacÃ­os
          for file in $(find public/blog -name "*.html" -newer .git/HEAD 2>/dev/null | head -3); do
            if [ -f "$file" ]; then
              SIZE=$(wc -c < "$file")
              WORDS=$(grep -o '<p>' "$file" | wc -l)
              echo "ğŸ“„ $(basename "$file"): $SIZE bytes, ~$WORDS pÃ¡rrafos"
            fi
          done

      - name: âœ… Test completado
        run: |
          echo "ğŸ‰ Test de generaciÃ³n completado"
          echo "ğŸ“… Ejecutado: $(date)"
          echo "ğŸ”§ Modo: ${{ github.event.inputs.test_mode }}"
          echo "ğŸ“Š Todo funcionando correctamente"

  # Job para validar que los archivos cumplen estÃ¡ndares
  validate-quality:
    runs-on: ubuntu-latest
    needs: test-generation
    if: always()
    
    steps:
      - name: ğŸ”„ Checkout cÃ³digo actualizado
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependencias
        run: npm ci

      - name: ğŸ§ª Validar calidad AdSense
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ” Validando cumplimiento AdSense..."
          
          # Ejecutar validaciÃ³n solo si hay archivos para validar
          if [ -d "public/blog" ] && [ "$(ls -A public/blog)" ]; then
            node scripts/adsense-validation-test.js || echo "âš ï¸ ValidaciÃ³n con warnings"
          else
            echo "â„¹ï¸ No hay archivos para validar"
          fi

      - name: ğŸ“Š Resumen final
        run: |
          echo "ğŸ“‹ RESUMEN DE TEST:"
          echo "âœ… GeneraciÃ³n: Completada"
          echo "ğŸ” ValidaciÃ³n: Ejecutada"
          echo "ğŸ“… Timestamp: $(date)"
          echo "ğŸ¯ Sistema listo para producciÃ³n"
