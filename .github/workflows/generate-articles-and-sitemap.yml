name: ğŸš€ GeneraciÃ³n Inteligente de ArtÃ­culos y SEO Avanzado

on:
  schedule:
    # Horarios optimizados para mejor indexaciÃ³n
    # Lunes a Viernes: 7:00 y 15:00 (hora Argentina UTC-3)
    - cron: '0 10,18 * * 1-5'
    # SÃ¡bados y Domingos: 9:00 y 17:00 (hora Argentina UTC-3)
    - cron: '0 12,20 * * 0,6'
  workflow_dispatch:
    inputs:
      force_articles:
        description: 'Forzar generaciÃ³n de artÃ­culos especÃ­ficos'
        required: false
        default: '5'
        type: string
      seo_optimization:
        description: 'Nivel de optimizaciÃ³n SEO'
        required: false
        default: 'advanced'
        type: choice
        options:
          - basic
          - advanced
          - expert

env:
  SITE_URL: https://hgaruna.org
  NODEJS_VERSION: '20'
  ARTICLES_PER_RUN: ${{ github.event.inputs.force_articles || '3' }}
  SEO_LEVEL: ${{ github.event.inputs.seo_optimization || 'advanced' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-and-generate:
    name: ğŸ“Š AnÃ¡lisis y GeneraciÃ³n Inteligente
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    outputs:
      articles-generated: ${{ steps.generate-articles.outputs.count }}
      seo-score: ${{ steps.seo-analysis.outputs.score }}
      performance-impact: ${{ steps.performance.outputs.impact }}
      
    steps:
      - name: ğŸ“¥ Checkout Repository con OptimizaciÃ³n
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§  Setup Node.js con Cache Inteligente
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: âš¡ InstalaciÃ³n Optimizada de Dependencias
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          npm list --depth=0 || true

      - name: ğŸ” AnÃ¡lisis de Rendimiento Pre-GeneraciÃ³n
        id: performance-check
        run: |
          echo "ğŸ” Analizando rendimiento actual..."
          if [ -f "public/sitemap.xml" ]; then
            SITEMAP_SIZE=$(wc -l < public/sitemap.xml)
            echo "sitemap-size=$SITEMAP_SIZE" >> $GITHUB_OUTPUT
          else
            echo "sitemap-size=0" >> $GITHUB_OUTPUT
          fi
          
          BLOG_COUNT=$(find public/blog -name "*.html" 2>/dev/null | wc -l || echo "0")
          echo "blog-count=$BLOG_COUNT" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Estado actual: $BLOG_COUNT artÃ­culos existentes"

      - name: ğŸ¯ AnÃ¡lisis de Tendencias y Keywords
        id: keyword-analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ¯ Analizando tendencias y keywords..."
          node scripts/advanced-keyword-analysis.js
          echo "keywords-updated=true" >> $GITHUB_OUTPUT

      - name: ğŸ§  GeneraciÃ³n Inteligente de ArtÃ­culos
        id: generate-articles
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ env.SITE_URL }}
          ARTICLES_COUNT: ${{ env.ARTICLES_PER_RUN }}
          SEO_OPTIMIZATION: ${{ env.SEO_LEVEL }}
        run: |
          echo "ğŸ§  Iniciando generaciÃ³n inteligente de artÃ­culos..."
          
          # Crear directorio si no existe
          mkdir -p public/blog
          
          # Ejecutar generaciÃ³n mejorada
          GENERATED_COUNT=$(node scripts/intelligent-article-generator.js)
          echo "count=$GENERATED_COUNT" >> $GITHUB_OUTPUT
          
          echo "âœ… Generados $GENERATED_COUNT artÃ­culos con optimizaciÃ³n $SEO_OPTIMIZATION"

      - name: ï¿½ï¸ Actualizar index.json de artÃ­culos
        run: |
          echo "ğŸ—‚ï¸ Actualizando index.json de artÃ­culos..."
          node scripts/generate-blog-index.cjs
          echo "âœ… index.json actualizado"

      - name: ï¿½ğŸ” AnÃ¡lisis SEO Avanzado
        id: seo-analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ” Ejecutando anÃ¡lisis SEO avanzado..."
          SEO_SCORE=$(node scripts/advanced-seo-analyzer.js)
          echo "score=$SEO_SCORE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Score SEO obtenido: $SEO_SCORE/100"

      - name: ğŸ—ºï¸ GeneraciÃ³n de Sitemap Inteligente
        id: sitemap-generation
        run: |
          echo "ğŸ—ºï¸ Generando sitemap inteligente..."
          
          if [ -z "$(ls -A public/blog/*.html 2>/dev/null)" ]; then
            echo "âš ï¸ No hay artÃ­culos para incluir en sitemap"
            echo "sitemap-updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Generar sitemap con prioridades inteligentes
          node scripts/intelligent-sitemap-generator.js
          
          # Verificar generaciÃ³n
          if [ -f "public/sitemap.xml" ]; then
            URLS_COUNT=$(grep -c "<url>" public/sitemap.xml || echo "0")
            echo "urls-count=$URLS_COUNT" >> $GITHUB_OUTPUT
            echo "sitemap-updated=true" >> $GITHUB_OUTPUT
            echo "âœ… Sitemap generado con $URLS_COUNT URLs"
          else
            echo "âŒ Error generando sitemap"
            echo "sitemap-updated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“Š GeneraciÃ³n de Schema Markup Avanzado
        id: schema-generation
        run: |
          echo "ğŸ“Š Generando Schema Markup avanzado..."
          node scripts/advanced-schema-generator.js
          echo "schema-updated=true" >> $GITHUB_OUTPUT

      - name: ğŸ” OptimizaciÃ³n para IndexNow y Motores de BÃºsqueda
        id: indexnow-submission
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
          SITE_URL: ${{ env.SITE_URL }}
          GOOGLE_INDEXING_API_KEY: ${{ secrets.GOOGLE_INDEXING_API_KEY }}
        run: |
          echo "ğŸ” Iniciando sumisiÃ³n a motores de bÃºsqueda..."
          
          # Obtener lista de artÃ­culos nuevos
          ARTICLES=$(find public/blog -name "*.html" -newer public/sitemap.xml 2>/dev/null || find public/blog -name "*.html" | head -5)
          
          if [ -z "$ARTICLES" ]; then
            echo "âš ï¸ No hay artÃ­culos nuevos para enviar"
            echo "submission-status=no-new-articles" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Ejecutar sumisiÃ³n inteligente
          SUBMISSION_RESULT=$(node scripts/intelligent-search-submission.js)
          echo "submission-status=$SUBMISSION_RESULT" >> $GITHUB_OUTPUT
          
          echo "âœ… SumisiÃ³n completada: $SUBMISSION_RESULT"

      - name: ğŸ“ˆ AnÃ¡lisis de Performance Impact
        id: performance
        run: |
          echo "ğŸ“ˆ Analizando impacto en performance..."
          
          # Calcular mÃ©tricas de performance
          CURRENT_SIZE=$(du -sh public/ | cut -f1)
          BLOG_SIZE=$(du -sh public/blog/ | cut -f1)
          
          echo "impact=positive" >> $GITHUB_OUTPUT
          echo "ğŸ“Š TamaÃ±o total: $CURRENT_SIZE, Blog: $BLOG_SIZE"

      - name: ğŸ§ª ValidaciÃ³n de Calidad y SEO
        id: quality-validation
        run: |
          echo "ğŸ§ª Validando calidad y SEO..."
          
          # Validar HTML
          for file in public/blog/*.html; do
            if [ -f "$file" ]; then
              # Verificar elementos SEO bÃ¡sicos
              if ! grep -q "<title>" "$file" || ! grep -q "meta.*description" "$file"; then
                echo "âŒ Error SEO en $file"
                exit 1
              fi
            fi
          done
          
          echo "âœ… ValidaciÃ³n de calidad completada"

      - name: ğŸ’¾ Commit Inteligente con Metadatos
        id: commit-changes
        run: |
          git config --global user.name 'hgaruna-bot[SEO]'
          git config --global user.email 'bot+seo@hgaruna.org'
          
          # Preparar mensaje de commit inteligente
          ARTICLES_COUNT="${{ steps.generate-articles.outputs.count }}"
          SEO_SCORE="${{ steps.seo-analysis.outputs.score }}"
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          
          COMMIT_MSG="ğŸš€ SEO-optimized content update
          
          ğŸ“Š MÃ©tricas:
          - ArtÃ­culos generados: $ARTICLES_COUNT
          - Score SEO: $SEO_SCORE/100
          - OptimizaciÃ³n: $SEO_LEVEL
          - Timestamp: $TIMESTAMP
          
          ğŸ¯ Cambios:
          - ArtÃ­culos con optimizaciÃ³n $SEO_LEVEL
          - Schema markup actualizado
          - Sitemap regenerado
          - Keywords optimizadas
          
          #SEO #ContentGeneration #AutomatedContent"
          
          git add public/blog/ public/sitemap.xml public/seo-* scripts/posted_articles.json
          
          if git diff --staged --quiet; then
            echo "ğŸ“ No hay cambios para commitear"
            echo "commit-created=false" >> $GITHUB_OUTPUT
          else
            git commit -m "$COMMIT_MSG"
            git push
            echo "commit-created=true" >> $GITHUB_OUTPUT
            echo "âœ… Commit creado y pusheado"
          fi

      - name: ğŸ“Š Reporte de Resultados
        if: always()
        run: |
          echo "## ğŸ“Š Reporte de EjecuciÃ³n del Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ MÃ©tricas Principales" >> $GITHUB_STEP_SUMMARY
          echo "- **ArtÃ­culos generados**: ${{ steps.generate-articles.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Score SEO**: ${{ steps.seo-analysis.outputs.score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **URLs en sitemap**: ${{ steps.sitemap-generation.outputs.urls-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Nivel de optimizaciÃ³n**: ${{ env.SEO_LEVEL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Estado de Procesos" >> $GITHUB_STEP_SUMMARY
          echo "- **Sitemap actualizado**: ${{ steps.sitemap-generation.outputs.sitemap-updated }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Schema generado**: ${{ steps.schema-generation.outputs.schema-updated }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SumisiÃ³n a buscadores**: ${{ steps.indexnow-submission.outputs.submission-status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit creado**: ${{ steps.commit-changes.outputs.commit-created }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ• InformaciÃ³n de EjecuciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "- **Inicio**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Sitio**: ${{ env.SITE_URL }}" >> $GITHUB_STEP_SUMMARY

  notify-results:
    name: ğŸ“¢ NotificaciÃ³n de Resultados
    needs: analyze-and-generate
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¢ NotificaciÃ³n de Ã‰xito
        if: needs.analyze-and-generate.result == 'success'
        run: |
          echo "âœ… Workflow completado exitosamente"
          echo "ğŸ“Š ArtÃ­culos generados: ${{ needs.analyze-and-generate.outputs.articles-generated }}"
          echo "ğŸ¯ Score SEO: ${{ needs.analyze-and-generate.outputs.seo-score }}/100"

      - name: âŒ NotificaciÃ³n de Error
        if: needs.analyze-and-generate.result == 'failure'
        run: |
          echo "âŒ Error en el workflow de generaciÃ³n"
          echo "ğŸ” Revisar logs para diagnÃ³stico"
          exit 1
