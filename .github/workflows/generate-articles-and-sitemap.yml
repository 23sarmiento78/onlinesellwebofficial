
name: Generar art칤culos HTML y crear sitemap


on:
  schedule:
    # 9:00, 13:00 y 19:00 UTC (6:00, 10:00 y 16:00 ART)
    - cron: '0 9 * * *'   # 6:00 ART
    - cron: '0 13 * * *'  # 10:00 ART
    - cron: '0 19 * * *'  # 16:00 ART
  workflow_dispatch:

jobs:
  generar-articulos-html-y-sitemap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias
        run: npm install


      - name: Configurar entorno
        env:
          SITE_URL: https://hgaruna.org
        run: |
          echo "SITE_URL=$SITE_URL" >> $GITHUB_ENV

      - name: Generar art칤culos HTML con Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          # Crear directorio de art칤culos si no existe
          mkdir -p public/blog
          
          # Ejecutar generador de art칤culos
          node scripts/generate-html-articles-gemini.js

      - name: Publicar en Reddit
        if: success()
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_REFRESH_TOKEN: ${{ secrets.REDDIT_REFRESH_TOKEN }}
          REDDIT_SUBREDDIT: 'r/programming'
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          # Verificar si el script de publicaci칩n existe
          if [ -f "scripts/publish-to-reddit.js" ]; then
            echo "游닊 Publicando en Reddit..."
            node scripts/publish-to-reddit.js
          else
            echo "丘멆잺  No se encontr칩 el script de publicaci칩n en Reddit"
          fi

      - name: Actualizar sitemap
        env:
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          # Verificar si hay art칤culos generados
          if [ -z "$(ls -A public/blog/*.html 2>/dev/null)" ]; then
            echo "No se encontraron art칤culos para incluir en el sitemap"
            exit 0
          fi
          
          # Actualizar sitemap
          node scripts/update_sitemap.js
          
          # Mostrar contenido del sitemap generado
          echo "\n游늯 Contenido del sitemap generado:"
          cat public/sitemap.xml | head -n 20
          echo "..."

      - name: Verificar art칤culos generados
        run: |
          echo "游늭 Contenido del directorio public/blog/:"
          ls -la public/blog/
          
          # Mostrar informaci칩n de los art칤culos generados
          for file in public/blog/*.html; do
            echo "\n游늯 $file:"
            echo "Tama침o: $(wc -c < "$file") bytes"
            echo "Primeras l칤neas:"
            head -n 10 "$file" | sed 's/^/  /'
            echo "..."
          done

      - name: Asegurar carpetas para Netlify
        run: |
          mkdir -p public/blog
          touch public/blog/.keep

      - name: Commit y push de art칤culos y sitemap
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/blog public/sitemap.xml scripts/posted_articles.json
          git commit -m "[bot] Art칤culos HTML y sitemap actualizados - $(date '+%Y-%m-%d %H:%M:%S') ART" || echo "Nada para commitear"
          git push || echo "Nada para pushear"
