name: Generar artÃ­culos HTML y crear sitemap

on:
  schedule:
    # Lunes a Viernes: 8:00 y 16:00 (hora local Argentina)
    - cron: '0 11,19 * * 1-5'
    # SÃ¡bados y Domingos: 10:00 y 18:00 (hora local Argentina)
    - cron: '0 13,21 * * 0,6'
  workflow_dispatch:

jobs:
  generar-articulos-html-y-sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: ğŸ”§ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Instalar dependencias
        run: npm install

      - name: âš™ï¸ Configurar variables de entorno
        env:
          SITE_URL: https://www.hgaruna.org
        run: echo "SITE_URL=$SITE_URL" >> $GITHUB_ENV

      - name: ğŸ§  Generar artÃ­culos HTML con Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          mkdir -p public/blog
          node scripts/generate-html-articles-gemini.js

      #- name: ğŸ“£ Publicar en Reddit
       # if: success()
       # env:
        #  REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
        #  REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        #  REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
        #  REDDIT_REFRESH_TOKEN: ${{ secrets.REDDIT_REFRESH_TOKEN }}
        #  REDDIT_SUBREDDITS: 'programming'
        #  REDDIT_PREFIX_TEXT: 'ğŸ’¡ hgaruna tips y mini consejos de programaciÃ³n:'
        #  SITE_URL: ${{ env.SITE_URL }}
       # run: |
        #  if [ -f "scripts/publish-to-socials.js" ]; then
         #   echo "ğŸ“¢ Ejecutando publicaciÃ³n en Reddit..."
          #  node scripts/publish-to-socials.js
         # else
         #   echo "âš ï¸ Script de publicaciÃ³n no encontrado: scripts/publish-to-socials.js"
         # fi

      - name: ğŸ—ºï¸ Actualizar sitemap
        run: |
          if [ -z "$(ls -A public/blog/*.html 2>/dev/null)" ]; then
            echo "âš ï¸ No hay artÃ­culos HTML para el sitemap"
            exit 0
          fi
          node scripts/update_sitemap.js
          echo "\nğŸ“„ Sitemap generado (primeras lÃ­neas):"
          head -n 20 public/sitemap.xml || echo "âš ï¸ No se encontrÃ³ sitemap.xml"

      - name: ğŸ” Verificar artÃ­culos generados
        run: |
          echo "ğŸ“‚ Archivos en public/blog:"
          ls -la public/blog/
          for file in public/blog/*.html; do
            echo "\nğŸ“„ $file:"
            echo "TamaÃ±o: $(wc -c < "$file") bytes"
            head -n 10 "$file" | sed 's/^/  /'
            echo "..."
          done

      - name: ğŸ§­ Actualizar Ã­ndice del blog
        run: |
          echo "ğŸ”„ Generando Ã­ndice del blog..."
          node scripts/generate-blog-index.js
          echo "ğŸ“„ Vista previa de index.json:"
          head -n 10 public/blog/index.json || echo "âš ï¸ index.json no encontrado"

      - name: ğŸ“ Asegurar carpetas para Netlify
        run: |
          mkdir -p public/blog
          touch public/blog/.keep

      - name: ğŸ’¾ Commit y push de artÃ­culos, sitemap e Ã­ndice
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/blog public/sitemap.xml scripts/posted_articles.json
          git commit -m "[bot] ArtÃ­culos HTML y sitemap actualizados - $(date '+%Y-%m-%d %H:%M:%S') ART" || echo "Nada para commitear"
          git push || echo "Nada para pushear"
