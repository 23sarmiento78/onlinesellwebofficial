name: Generar artículos educativos con AdSense y sitemap

on:
  schedule:
    # 9:00, 13:00 y 19:00 UTC (6:00, 10:00 y 16:00 ART)
    - cron: '0 9 * * *'   # 6:00 ART
    - cron: '0 13 * * *'  # 10:00 ART
    - cron: '0 19 * * *'  # 16:00 ART
  workflow_dispatch:

jobs:
  generar-articulos-educativos-adsense:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias
        run: npm install

      - name: Generar 3 artículos educativos optimizados para AdSense
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/generate-educational-articles-adsense.js --count=3

      - name: Generar artículos de programación para principiantes
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/generate-programming-tutorials.js --count=2

      - name: Copiar artículos HTML generados a public/blog
        run: |
          mkdir -p public/blog
          cp -u scripts/generated-html/*.html public/blog/ 2>/dev/null || echo "No hay archivos nuevos para copiar"

      - name: Optimizar artículos para SEO y AdSense
        run: node scripts/optimize-articles-adsense.js

      - name: Agregar meta categoría y schema markup
        run: node scripts/add-category-meta.js

      - name: Generar índice de artículos educativos
        run: node scripts/generate-educational-index.js

      - name: Actualizar página de aprendizaje
        run: node scripts/update-learning-page.js

      - name: Validar compliance AdSense
        run: node scripts/validate-adsense-compliance.js

      - name: Publicar en Redes Sociales
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_REFRESH_TOKEN: ${{ secrets.REDDIT_REFRESH_TOKEN }}
          REDDIT_SUBREDDIT: 'r/learnprogramming'
        run: node scripts/publish-educational-content.js

      - name: Subir imágenes educativas como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: educational-images
          path: public/educational-images/

      - name: Actualizar sitemap con contenido educativo
        run: node scripts/update-educational-sitemap.js

      - name: Copiar sitemap.xml a build/
        run: |
          mkdir -p build
          cp public/sitemap.xml build/sitemap.xml

      - name: Asegurar carpetas para Netlify
        run: |
          mkdir -p public/blog
          mkdir -p public/aprende-programacion
          touch public/blog/.keep
          touch public/aprende-programacion/.keep

      - name: Commit y push de contenido educativo y sitemap
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/blog public/data public/aprende-programacion public/sitemap.xml scripts/posted_articles.json
          git commit -m "[bot] Contenido educativo con AdSense actualizado - $(date '+%Y-%m-%d %H:%M:%S') ART" || echo "Nada para commitear"
          git push || echo "Nada para pushear"
