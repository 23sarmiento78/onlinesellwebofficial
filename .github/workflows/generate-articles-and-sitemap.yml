name: Generar artÃ­culos HTML y crear sitemap

on:
  schedule:
    # Lunes a Viernes: 8:00 y 16:00 (hora local Argentina)
    - cron: '0 11,19 * * 1-5'
    # SÃ¡bados y Domingos: 10:00 y 18:00 (hora local Argentina)
    - cron: '0 13,21 * * 0,6'
  workflow_dispatch:

jobs:
  generar-articulos-html-y-sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: ğŸ”§ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Instalar dependencias
        run: npm install

      - name: âš™ï¸ Configurar variables de entorno
        env:
          SITE_URL: https://www.hgaruna.org
        run: echo "SITE_URL=$SITE_URL" >> $GITHUB_ENV

      - name: ğŸ§  Generar artÃ­culos HTML con Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          mkdir -p public/blog
          node scripts/generate-html-articles-gemini.js

      #- name: ğŸ“£ Publicar en Reddit
       # if: success()
       # env:
        #  REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
        #  REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        #  REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
        #  REDDIT_REFRESH_TOKEN: ${{ secrets.REDDIT_REFRESH_TOKEN }}
        #  REDDIT_SUBREDDITS: 'programming'
        #  REDDIT_PREFIX_TEXT: 'ğŸ’¡ hgaruna tips y mini consejos de programaciÃ³n:'
        #  SITE_URL: ${{ env.SITE_URL }}
       # run: |
        #  if [ -f "scripts/publish-to-socials.js" ]; then
         #   echo "ğŸ“¢ Ejecutando publicaciÃ³n en Reddit..."
          #  node scripts/publish-to-socials.js
         # else
         #   echo "âš ï¸ Script de publicaciÃ³n no encontrado: scripts/publish-to-socials.js"
         # fi

      - name: ğŸ—ºï¸ Actualizar sitemap
        run: |
          if [ -z "$(ls -A public/blog/*.html 2>/dev/null)" ]; then
            echo "âš ï¸ No hay artÃ­culos HTML para el sitemap"
            exit 0
          fi
          node scripts/update_sitemap.js
          echo "\nğŸ“„ Sitemap generado (primeras lÃ­neas):"
          head -n 20 public/sitemap.xml || echo "âš ï¸ No se encontrÃ³ sitemap.xml"

      - name: ğŸ” Verificar artÃ­culos generados
        run: |
          echo "ğŸ“‚ Archivos en public/blog:"
          ls -la public/blog/
          for file in public/blog/*.html; do
            echo "\nğŸ“„ $file:"
            echo "TamaÃ±o: $(wc -c < "$file") bytes"
            head -n 10 "$file" | sed 's/^/  /'
            echo "..."
          done

      - name: ğŸ§­ Actualizar Ã­ndice del blog
        run: |
          echo "ğŸ”„ Generando Ã­ndice del blog..."
          node scripts/generate-blog-index.js
          echo "ğŸ“„ Vista previa de index.json:"
          head -n 10 public/blog/index.json || echo "âš ï¸ index.json no encontrado"

      - name: ğŸ” Enviar URLs a IndexNow
        if: success()
        env:
          SITE_URL: ${{ env.SITE_URL }}
        run: |
          echo "ğŸ” Instalando dependencias necesarias..."
          npm install axios jq
          
          echo "ğŸ”„ Obteniendo lista de artÃ­culos..."
          # Obtener archivos HTML de artÃ­culos
          ARTICLES=$(find public/blog -name "*.html" ! -name "index.html" | sed 's|public/blog/||' | sed 's/.html$//')
          
          if [ -z "$ARTICLES" ]; then
            echo "âš ï¸ No se encontraron artÃ­culos para enviar a IndexNow"
            exit 0
          fi
          
          echo "ğŸ“„ ArtÃ­culos encontrados:"
          echo "$ARTICLES" | sed 's/^/  - /'
          
          # Crear archivo temporal con las URLs
          echo "ğŸ“ Creando archivo temporal con URLs..."
          echo 'const { submitToIndexNow } = require("./scripts/indexnow");' > temp-indexnow.js
          echo 'const urls = [' >> temp-indexnow.js
          for article in $ARTICLES; do
            echo "  '${SITE_URL}/blog/${article}'," >> temp-indexnow.js
          done
          echo '];' >> temp-indexnow.js
          echo 'submitToIndexNow(urls).then(success => process.exit(success ? 0 : 1));' >> temp-indexnow.js
          
          echo "ğŸš€ Enviando URLs a IndexNow..."
          node temp-indexnow.js
          RESULT=$?
          
          # Limpiar archivo temporal
          rm -f temp-indexnow.js
          
          if [ $RESULT -ne 0 ]; then
            echo "âš ï¸ Hubo un error al enviar a IndexNow"
            exit 1
          fi
          
          echo "âœ… URLs enviadas exitosamente a IndexNow"

      - name: ğŸ’¾ Commit y push de artÃ­culos, sitemap e Ã­ndice
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/blog public/sitemap.xml scripts/posted_articles.json
          git commit -m "[bot] ArtÃ­culos HTML y sitemap actualizados - $(date '+%Y-%m-%d %H:%M:%S') ART" || echo "Nada para commitear"
          git push || echo "Nada para pushear"
