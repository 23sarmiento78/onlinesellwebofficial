name: Generar artículos educativos con AdSense y sitemap

on:
  schedule:
    # 9:00, 13:00 y 19:00 UTC (6:00, 10:00 y 16:00 ART)
    - cron: '0 9 * * *'   # 6:00 ART
    - cron: '0 13 * * *'  # 10:00 ART
    - cron: '0 19 * * *'  # 16:00 ART
  workflow_dispatch:

jobs:
  generar-articulos-educativos-adsense:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Instalar dependencias
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Asegurar directorios requeridos
        run: |
          mkdir -p public/blog
          mkdir -p public/data

      - name: Generar artículos educativos optimizados para AdSense
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EDU_COUNT: ${{ vars.EDU_COUNT }}
        run: |
          COUNT=${EDU_COUNT:-3}
          timeout 900 node scripts/generate-educational-articles-adsense.js --count=$COUNT

      - name: Generar artículos de programación para principiantes
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TUTORIAL_COUNT: ${{ vars.TUTORIAL_COUNT }}
        run: |
          COUNT=${TUTORIAL_COUNT:-2}
          timeout 900 node scripts/generate-programming-tutorials.js --count=$COUNT

      - name: Optimizar artículos para SEO y AdSense
        run: timeout 600 node scripts/optimize-articles-adsense.js

      - name: Agregar meta categoría y schema markup
        run: timeout 300 node scripts/add-category-meta.js

      - name: Generar índice de artículos (JSON)
        run: timeout 300 node scripts/build-blog-index.js

      - name: Validar compliance AdSense
        run: timeout 600 node scripts/validate-adsense-compliance.js

      - name: Publicar en Redes Sociales
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_REFRESH_TOKEN: ${{ secrets.REDDIT_REFRESH_TOKEN }}
          REDDIT_SUBREDDIT: 'r/learnprogramming'
        run: timeout 300 node scripts/publish-to-socials-modern.js
        continue-on-error: true

      - name: Actualizar sitemap
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: timeout 120 node scripts/update-sitemap.js

      - name: Commit y push de contenido educativo y sitemap
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/blog public/data public/sitemap.xml
          git commit -m "[bot] Contenido educativo con AdSense actualizado - $(date '+%Y-%m-%d %H:%M:%S') ART" || echo "Nada para commitear"
          git push || echo "Nada para pushear"
