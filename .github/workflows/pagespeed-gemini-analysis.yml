name: PageSpeed & Gemini Performance Analysis

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  analyze_performance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Paso 1: Establecer la URL del sitio ---
      - name: Set Site URL
        id: set_url
        run: |
          echo "SITE_URL=https://hgaruna.org" >> $GITHUB_ENV

      # --- Paso 2: Ejecutar PageSpeed Insights API ---
      - name: Run PageSpeed Insights Analysis
        id: psi_analysis
        run: |
          # 춰CORRECCI칍N AQU칈! Cambiado 'pagespeedinsights' por 'pagespeedonline'
          PSI_URL="https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${{ env.SITE_URL }}&key=${{ secrets.API_KEY }}&strategy=mobile&locale=es"
          echo "Running PSI for: ${{ env.SITE_URL }}"
          curl -s "$PSI_URL" > pagespeed_report.json
          if [ ! -s pagespeed_report.json ]; then
            echo "Error: pagespeed_report.json est치 vac칤o o no se gener칩. La llamada a la API de PSI pudo haber fallado."
            exit 1
          fi
          echo "PSI Report generated."
        env:
          API_KEY: ${{ secrets.API_KEY }}

      # --- NUEVO PASO PARA INSPECCIONAR EL CONTENIDO (mantener para futuras depuraciones) ---
      - name: Inspect Generated PSI Report
        run: |
          echo "--- Contenido de pagespeed_report.json ---"
          cat pagespeed_report.json
          echo "-----------------------------------------"
          jq . pagespeed_report.json || echo "El contenido no es un JSON v치lido o jq no est치 disponible." # Mensaje m치s preciso
        if: always()

      # --- Paso 3: Enviar el Reporte a Gemini para An치lisis (Ejecuta el Script Python) ---
      - name: Send PSI Report to Gemini for Analysis
        id: gemini_analysis
        run: |
          pip install -q -U google-generativeai
          python scripts/gemini_analysis.py pagespeed_report.json gemini_analysis.md
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        if: success()

      # --- Paso 4: Publicar los Resultados de Gemini (ej. en un comentario de PR) ---
      - name: Comment on Pull Request with Gemini Suggestions
        if: github.event_name == 'pull_request' && success()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: 'performance-review'
          message: |
            ## 游 Revisi칩n de Rendimiento por Gemini (Powered by PageSpeed Insights)

            Aqu칤 tienes las sugerencias de mejora de rendimiento para este despliegue, generadas por Gemini (modelo 1.5 Flash) a partir del an치lisis de PageSpeed Insights para ${{ env.SITE_URL }}:

            ```markdown
            # Contenido del archivo gemini_analysis.md
            ${{ steps.gemini_analysis.outputs.gemini_suggestions }}
            ```

            ---
            *Este comentario es generado autom치ticamente.*
