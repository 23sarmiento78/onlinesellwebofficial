name: PageSpeed & Gemini Performance Analysis

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  analyze_performance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Paso 1: Establecer la URL del sitio ---
      - name: Set Site URL
        id: set_url
        run: |
          echo "SITE_URL=https://hgaruna.org" >> $GITHUB_ENV

      # --- Paso 2: Ejecutar PageSpeed Insights API ---
      - name: Run PageSpeed Insights Analysis
        id: psi_analysis
        run: |
          PSI_URL="https://www.googleapis.com/pagespeedinsights/v5/runPagespeed?url=${{ env.SITE_URL }}&key=${{ secrets.API_KEY }}&strategy=mobile&locale=es"
          echo "Running PSI for: ${{ env.SITE_URL }}"
          curl -s "$PSI_URL" > pagespeed_report.json
          echo "PSI Report generated."
        env:
          API_KEY: ${{ secrets.API_KEY }}

      # --- Paso 3: Enviar el Reporte a Gemini para Análisis (Ejecuta el Script Python) ---
      - name: Send PSI Report to Gemini for Analysis
        id: gemini_analysis
        run: |
          # Instala la librería de Google Generative AI
          pip install -q -U google-generativeai

          # Ejecuta el script de Python, pasándole la ruta del reporte PSI
          # y la ruta de salida para el análisis de Gemini.
          # La clave de API de Gemini se pasa como variable de entorno.
          python scripts/gemini_analysis.py pagespeed_report.json gemini_analysis.md
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      # --- Paso 4: Publicar los Resultados de Gemini (ej. en un comentario de PR) ---
      - name: Comment on Pull Request with Gemini Suggestions
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: 'performance-review'
          message: |
            ## 🚀 Revisión de Rendimiento por Gemini (Powered by PageSpeed Insights)

            Aquí tienes las sugerencias de mejora de rendimiento para este despliegue, generadas por Gemini (modelo 1.5 Flash) a partir del análisis de PageSpeed Insights para ${{ env.SITE_URL }}:

            ```markdown
            # Contenido del archivo gemini_analysis.md
            ${{ steps.gemini_analysis.outputs.gemini_suggestions }}
            ```

            ---
            *Este comentario es generado automáticamente.*
