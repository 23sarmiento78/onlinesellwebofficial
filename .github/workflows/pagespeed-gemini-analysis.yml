name: ğŸš€ AnÃ¡lisis Avanzado de Performance y SEO con IA

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  schedule:
    # AnÃ¡lisis diario a las 6:00 AM (Argentina UTC-3)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      analysis_depth:
        description: 'Profundidad del anÃ¡lisis'
        required: false
        default: 'comprehensive'
        type: choice
        options:
          - basic
          - comprehensive
          - expert
      pages_to_analyze:
        description: 'PÃ¡ginas a analizar (separadas por coma)'
        required: false
        default: 'home,blog,planes,contacto'
        type: string
      generate_report:
        description: 'Generar reporte detallado'
        required: false
        default: true
        type: boolean

env:
  SITE_URL: https://hgaruna.org
  ANALYSIS_DEPTH: ${{ github.event.inputs.analysis_depth || 'comprehensive' }}
  PAGES_INPUT: ${{ github.event.inputs.pages_to_analyze || 'home,blog,planes,contacto' }}
  GENERATE_REPORT: ${{ github.event.inputs.generate_report || 'true' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  performance-analysis:
    name: ğŸ“Š AnÃ¡lisis de Performance Multi-PÃ¡gina
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    outputs:
      overall-score: ${{ steps.aggregate-results.outputs.overall-score }}
      critical-issues: ${{ steps.aggregate-results.outputs.critical-issues }}
      recommendations: ${{ steps.aggregate-results.outputs.recommendations }}
      
    strategy:
      matrix:
        device: [mobile, desktop]
        
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ§  Setup Node.js con Cache
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ Setup Python para Gemini
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ InstalaciÃ³n de Dependencias
        run: |
          npm ci --prefer-offline --no-audit
          pip install -q -U google-generativeai requests beautifulsoup4 selenium

      - name: ğŸ¯ ConfiguraciÃ³n de URLs de AnÃ¡lisis
        id: setup-urls
        run: |
          echo "ğŸ¯ Configurando URLs para anÃ¡lisis..."
          
          # Mapear pÃ¡ginas a URLs completas
          PAGES="${{ env.PAGES_INPUT }}"
          URLS=""
          
          IFS=',' read -ra PAGE_ARRAY <<< "$PAGES"
          for page in "${PAGE_ARRAY[@]}"; do
            case $page in
              "home")
                URLS="$URLS,${{ env.SITE_URL }}/"
                ;;
              "blog")
                URLS="$URLS,${{ env.SITE_URL }}/blog"
                ;;
              "planes")
                URLS="$URLS,${{ env.SITE_URL }}/planes"
                ;;
              "contacto")
                URLS="$URLS,${{ env.SITE_URL }}/contacto"
                ;;
              "desarrollo-web")
                URLS="$URLS,${{ env.SITE_URL }}/desarrollo-web-villa-carlos-paz"
                ;;
              "diseÃ±o-web")
                URLS="$URLS,${{ env.SITE_URL }}/diseÃ±o-web-villa-carlos-paz"
                ;;
              "marketing-digital")
                URLS="$URLS,${{ env.SITE_URL }}/marketing-digital-villa-carlos-paz"
                ;;
              *)
                URLS="$URLS,${{ env.SITE_URL }}/$page"
                ;;
            esac
          done
          
          # Remover coma inicial
          URLS=${URLS#,}
          echo "urls=$URLS" >> $GITHUB_OUTPUT
          echo "ğŸ“Š URLs configuradas: $URLS"

      - name: ğŸ” AnÃ¡lisis PageSpeed Insights Avanzado
        id: psi-analysis
        env:
          GOOGLE_PSI_API_KEY: ${{ secrets.GOOGLE_PSI_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "ğŸ” Ejecutando anÃ¡lisis PageSpeed Insights para ${{ matrix.device }}..."
          
          mkdir -p reports/psi/${{ matrix.device }}
          
          # Obtener URLs
          URLS="${{ steps.setup-urls.outputs.urls }}"
          IFS=',' read -ra URL_ARRAY <<< "$URLS"
          
          TOTAL_SCORE=0
          URL_COUNT=0
          
          for url in "${URL_ARRAY[@]}"; do
            echo "ğŸ“Š Analizando: $url"
            
            # Ejecutar anÃ¡lisis PSI
            PSI_URL="https://www.googleapis.com/pagespeedonline/v5/runPagespeed"
            PSI_URL+="?url=$url"
            PSI_URL+="&key=${GOOGLE_PSI_API_KEY:-${API_KEY}}"
            PSI_URL+="&strategy=${{ matrix.device }}"
            PSI_URL+="&locale=es"
            PSI_URL+="&category=performance&category=accessibility&category=best-practices&category=seo"
            
            # Generar nombre de archivo seguro
            FILENAME=$(echo "$url" | sed 's|https\?://||g' | sed 's|[^a-zA-Z0-9]|-|g')
            OUTPUT_FILE="reports/psi/${{ matrix.device }}/${FILENAME}.json"
            
            # Ejecutar anÃ¡lisis con retry
            for i in {1..3}; do
              if curl -s --fail "$PSI_URL" > "$OUTPUT_FILE"; then
                # Verificar que el archivo tiene contenido vÃ¡lido
                if jq -e '.lighthouseResult.categories.performance.score' "$OUTPUT_FILE" > /dev/null 2>&1; then
                  SCORE=$(jq -r '.lighthouseResult.categories.performance.score' "$OUTPUT_FILE")
                  SCORE_PERCENT=$(echo "$SCORE * 100" | bc -l | cut -d. -f1)
                  echo "âœ… $url: $SCORE_PERCENT%"
                  TOTAL_SCORE=$((TOTAL_SCORE + SCORE_PERCENT))
                  URL_COUNT=$((URL_COUNT + 1))
                  break
                else
                  echo "âš ï¸ Respuesta invÃ¡lida para $url, intento $i"
                  rm -f "$OUTPUT_FILE"
                fi
              else
                echo "âš ï¸ Error en anÃ¡lisis de $url, intento $i"
              fi
              
              if [ $i -eq 3 ]; then
                echo "âŒ FallÃ³ anÃ¡lisis de $url despuÃ©s de 3 intentos"
                echo '{"error": "Failed to analyze", "url": "'$url'"}' > "$OUTPUT_FILE"
              else
                sleep $((i * 2))
              fi
            done
          done
          
          # Calcular score promedio
          if [ $URL_COUNT -gt 0 ]; then
            AVERAGE_SCORE=$((TOTAL_SCORE / URL_COUNT))
            echo "average-score=$AVERAGE_SCORE" >> $GITHUB_OUTPUT
            echo "urls-analyzed=$URL_COUNT" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Score promedio ${{ matrix.device }}: $AVERAGE_SCORE%"
          else
            echo "average-score=0" >> $GITHUB_OUTPUT
            echo "urls-analyzed=0" >> $GITHUB_OUTPUT
            echo "âŒ No se pudo analizar ninguna URL"
          fi

      - name: ğŸ§ª AnÃ¡lisis de Core Web Vitals
        id: cwv-analysis
        run: |
          echo "ğŸ§ª Analizando Core Web Vitals..."
          
          # Procesar reportes PSI para extraer CWV
          node scripts/advanced-cwv-analyzer.js \
            --input-dir="reports/psi/${{ matrix.device }}" \
            --output="reports/cwv-${{ matrix.device }}.json" \
            --device="${{ matrix.device }}"

      - name: ğŸ¯ AnÃ¡lisis de Oportunidades de OptimizaciÃ³n
        id: optimization-analysis
        run: |
          echo "ğŸ¯ Identificando oportunidades de optimizaciÃ³n..."
          
          # Analizar oportunidades especÃ­ficas por dispositivo
          node scripts/optimization-opportunities-analyzer.js \
            --input-dir="reports/psi/${{ matrix.device }}" \
            --output="reports/opportunities-${{ matrix.device }}.json" \
            --device="${{ matrix.device }}"

      - name: ğŸ“Š Upload Reports Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports-${{ matrix.device }}
          path: reports/
          retention-days: 30

  gemini-ai-analysis:
    name: ğŸ§  AnÃ¡lisis Inteligente con Gemini
    needs: performance-analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      ai-recommendations: ${{ steps.gemini-analysis.outputs.recommendations }}
      priority-issues: ${{ steps.gemini-analysis.outputs.priority-issues }}
      improvement-plan: ${{ steps.gemini-analysis.outputs.improvement-plan }}
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python para Gemini
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ InstalaciÃ³n de Dependencias Python
        run: |
          pip install -q -U google-generativeai requests beautifulsoup4 pandas matplotlib seaborn

      - name: ğŸ“Š Download Performance Reports
        uses: actions/download-artifact@v4
        with:
          pattern: performance-reports-*
          path: reports/
          merge-multiple: true

      - name: ğŸ§  AnÃ¡lisis Inteligente con Gemini
        id: gemini-analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: ${{ env.SITE_URL }}
          ANALYSIS_DEPTH: ${{ env.ANALYSIS_DEPTH }}
        run: |
          echo "ğŸ§  Ejecutando anÃ¡lisis inteligente con Gemini..."
          
          # Ejecutar anÃ¡lisis avanzado con Gemini
          python scripts/advanced-gemini-performance-analyzer.py \
            --reports-dir="reports/" \
            --site-url="${{ env.SITE_URL }}" \
            --analysis-depth="${{ env.ANALYSIS_DEPTH }}" \
            --output-dir="analysis-results/"

      - name: ğŸ“ˆ GeneraciÃ³n de Visualizaciones
        run: |
          echo "ğŸ“ˆ Generando visualizaciones..."
          
          # Generar grÃ¡ficos y visualizaciones
          python scripts/performance-visualizer.py \
            --input-dir="analysis-results/" \
            --output-dir="visualizations/"

      - name: ğŸ“„ GeneraciÃ³n de Reporte HTML
        if: env.GENERATE_REPORT == 'true'
        run: |
          echo "ğŸ“„ Generando reporte HTML..."
          
          # Generar reporte interactivo
          python scripts/generate-performance-report.py \
            --analysis-dir="analysis-results/" \
            --visualizations-dir="visualizations/" \
            --output="performance-report.html"

      - name: ğŸ“Š Upload Analysis Results
        uses: actions/upload-artifact@v4
        with:
          name: gemini-analysis-results
          path: |
            analysis-results/
            visualizations/
            performance-report.html
          retention-days: 30

  aggregate-and-report:
    name: ğŸ“‹ AgregaciÃ³n y Reporte Final
    needs: [performance-analysis, gemini-ai-analysis]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“Š Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all-results/

      - name: ğŸ“‹ AgregaciÃ³n de Resultados
        id: aggregate-results
        run: |
          echo "ğŸ“‹ Agregando resultados de anÃ¡lisis..."
          
          # Procesar todos los resultados
          npm install --no-save jq bc
          
          OVERALL_SCORE=0
          DEVICE_COUNT=0
          CRITICAL_ISSUES=""
          
          # Calcular score general
          for device in mobile desktop; do
            if [ -f "all-results/performance-reports-$device/cwv-$device.json" ]; then
              DEVICE_SCORE=$(jq -r '.overall_score // 0' "all-results/performance-reports-$device/cwv-$device.json")
              OVERALL_SCORE=$((OVERALL_SCORE + DEVICE_SCORE))
              DEVICE_COUNT=$((DEVICE_COUNT + 1))
            fi
          done
          
          if [ $DEVICE_COUNT -gt 0 ]; then
            FINAL_SCORE=$((OVERALL_SCORE / DEVICE_COUNT))
          else
            FINAL_SCORE=0
          fi
          
          echo "overall-score=$FINAL_SCORE" >> $GITHUB_OUTPUT
          echo "critical-issues=optimization-needed" >> $GITHUB_OUTPUT
          echo "recommendations=available" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Score general: $FINAL_SCORE%"

      - name: ğŸ’¬ Comentario en PR (si aplica)
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: 'performance-analysis'
          message: |
            ## ğŸš€ AnÃ¡lisis de Performance Avanzado
            
            ### ğŸ“Š Resultados Generales
            - **Score General**: ${{ steps.aggregate-results.outputs.overall-score }}/100
            - **AnÃ¡lisis**: ${{ env.ANALYSIS_DEPTH }}
            - **PÃ¡ginas analizadas**: ${{ env.PAGES_INPUT }}
            
            ### ğŸ“± Resultados por Dispositivo
            | Dispositivo | Score Performance | Core Web Vitals |
            |-------------|------------------|-----------------|
            | ğŸ“± Mobile   | Calculando...    | Calculando...   |
            | ğŸ–¥ï¸ Desktop  | Calculando...    | Calculando...   |
            
            ### ğŸ¯ Principales Recomendaciones
            - AnÃ¡lisis detallado disponible en artifacts
            - Reporte interactivo generado con IA
            - Oportunidades de optimizaciÃ³n identificadas
            
            ### ğŸ”— Enlaces Ãštiles
            - [Ver reporte completo](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Descargar visualizaciones](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *AnÃ¡lisis generado automÃ¡ticamente con Gemini AI â€¢ ${{ env.SITE_URL }}*

      - name: ğŸ’¾ Commit de Resultados (si es push a main)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config --global user.name 'hgaruna-bot[PERFORMANCE]'
          git config --global user.email 'bot+performance@hgaruna.org'
          
          # Crear directorio de reportes si no existe
          mkdir -p reports/performance/$(date +%Y-%m)
          
          # Copiar resultados importantes
          if [ -f "performance-report.html" ]; then
            cp performance-report.html "reports/performance/$(date +%Y-%m)/report-$(date +%Y%m%d).html"
          fi
          
          # Crear resumen JSON
          cat > "reports/performance/latest.json" << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "overall_score": ${{ steps.aggregate-results.outputs.overall-score }},
            "analysis_depth": "${{ env.ANALYSIS_DEPTH }}",
            "pages_analyzed": "${{ env.PAGES_INPUT }}",
            "commit_sha": "${{ github.sha }}",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF
          
          git add reports/performance/
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“Š Performance analysis update - Score: ${{ steps.aggregate-results.outputs.overall-score }}/100

            ğŸ¯ Analysis Details:
            - Depth: ${{ env.ANALYSIS_DEPTH }}
            - Pages: ${{ env.PAGES_INPUT }}
            - Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
            - Commit: ${{ github.sha }}
            
            ğŸ“ˆ Generated with Gemini AI
            #PerformanceAnalysis #SEO #Optimization"
            
            git push
            echo "âœ… Resultados guardados en repositorio"
          else
            echo "ğŸ“ No hay cambios para commitear"
          fi

      - name: ğŸ“Š Reporte Final en Summary
        run: |
          echo "## ğŸš€ Reporte de AnÃ¡lisis de Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š MÃ©tricas Principales" >> $GITHUB_STEP_SUMMARY
          echo "- **Score General**: ${{ steps.aggregate-results.outputs.overall-score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **Profundidad de anÃ¡lisis**: ${{ env.ANALYSIS_DEPTH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PÃ¡ginas analizadas**: ${{ env.PAGES_INPUT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Sitio**: ${{ env.SITE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Estado del AnÃ¡lisis" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Analysis**: ${{ needs.performance-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Gemini AI Analysis**: ${{ needs.gemini-ai-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reporte generado**: ${{ env.GENERATE_REPORT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“… InformaciÃ³n de EjecuciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          
          # Estado general
          if [ "${{ steps.aggregate-results.outputs.overall-score }}" -gt 80 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Estado: EXCELENTE" >> $GITHUB_STEP_SUMMARY
            echo "El sitio tiene un rendimiento excelente." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.aggregate-results.outputs.overall-score }}" -gt 60 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ Estado: BUENO" >> $GITHUB_STEP_SUMMARY
            echo "El sitio tiene un buen rendimiento con margen de mejora." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ Estado: NECESITA MEJORAS" >> $GITHUB_STEP_SUMMARY
            echo "Se requieren optimizaciones para mejorar el rendimiento." >> $GITHUB_STEP_SUMMARY
          fi

  notify-teams:
    name: ğŸ“¢ Notificaciones
    needs: [performance-analysis, gemini-ai-analysis, aggregate-and-report]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¢ NotificaciÃ³n de Ã‰xito
        if: needs.aggregate-and-report.result == 'success'
        run: |
          echo "âœ… AnÃ¡lisis de performance completado exitosamente"
          echo "ğŸ“Š Score obtenido: ${{ needs.aggregate-and-report.outputs.overall-score }}/100"

      - name: âŒ NotificaciÃ³n de Error
        if: failure()
        run: |
          echo "âŒ Error en el anÃ¡lisis de performance"
          echo "ğŸ” Revisar logs para diagnÃ³stico detallado"
