<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n</title>
    <!-- SDK de Auth0 - Versi√≥n m√°s reciente -->
    <script src="https://unpkg.com/@auth0/auth0-spa-js@2.2.0/dist/auth0-spa-js.production.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .login-section {
            text-align: center;
            padding: 50px 20px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Panel de Administraci√≥n</h1>
            <div id="user-controls" class="hidden">
                <button id="logout-btn" class="btn btn-danger">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Secci√≥n de Loading -->
        <div id="loading-section" class="loading">
            <h2>Cargando...</h2>
            <p>Inicializando sistema de autenticaci√≥n</p>
        </div>

        <!-- Secci√≥n de Error -->
        <div id="error-section" class="error hidden">
            <h3>Error de Carga</h3>
            <p id="error-message">No se pudo cargar el SDK de Auth0</p>
            <button onclick="location.reload()" class="btn">üîÑ Recargar P√°gina</button>
        </div>

        <!-- Secci√≥n de Login -->
        <div id="login-section" class="login-section hidden">
            <h2>Iniciar Sesi√≥n</h2>
            <p>Para acceder al panel de administraci√≥n, debes iniciar sesi√≥n.</p>
            <button id="login-btn" class="btn">Iniciar Sesi√≥n</button>
        </div>

        <!-- Informaci√≥n del Usuario -->
        <div id="user-info" class="user-info hidden">
            <h3>Bienvenido, <span id="user-name">Usuario</span></h3>
            <p>Email: <span id="user-email">usuario@ejemplo.com</span></p>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard hidden">
            <div class="card">
                <h3>Gesti√≥n de Contenido</h3>
                <p>Administra art√≠culos, p√°ginas y contenido del sitio.</p>
                <button class="btn">Gestionar Contenido</button>
            </div>
            
            <div class="card">
                <h3>Configuraci√≥n</h3>
                <p>Configura el sitio web y ajustes generales.</p>
                <button class="btn">Configuraci√≥n</button>
            </div>
            
            <div class="card">
                <h3>Estad√≠sticas</h3>
                <p>Ver estad√≠sticas y an√°lisis del sitio.</p>
                <button class="btn">Ver Estad√≠sticas</button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Auth0
        const auth0Config = {
            domain: "dev-b0qip4vee7sg3q7e.us.auth0.com",
            clientId: "3X8sfPyJFDFhKetUdmn6gEs6tPH2lCab",
            authorizationParams: {
                redirect_uri: window.location.origin + "/admin/"
            },
            cacheLocation: "localstorage"
        };

        // Variable global para el cliente Auth0
        let auth0Client = null;

        // Funci√≥n para verificar si el SDK se carg√≥ correctamente
        function checkSDKLoaded() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 segundos
                
                const check = () => {
                    attempts++;
                    
                    if (typeof auth0 !== 'undefined' && auth0.createAuth0Client) {
                        console.log("‚úÖ SDK de Auth0 cargado correctamente");
                        resolve(auth0);
                    } else if (attempts >= maxAttempts) {
                        reject(new Error("SDK de Auth0 no se pudo cargar despu√©s de 5 segundos"));
                    } else {
                        setTimeout(check, 100);
                    }
                };
                
                check();
            });
        }

        // Funci√≥n para inicializar el cliente Auth0
        const configureClient = async () => {
            try {
                console.log("üîê Inicializando Auth0...");
                console.log("üìã Configuraci√≥n:", auth0Config);
                
                // Esperar a que el SDK se cargue
                const auth0SDK = await checkSDKLoaded();
                
                console.log("‚úÖ Auth0 SDK disponible");
                console.log("üîß M√©todos disponibles:", Object.keys(auth0SDK));
                
                // Crear el cliente
                auth0Client = await auth0SDK.createAuth0Client(auth0Config);
                console.log("‚úÖ Auth0 client creado:", auth0Client);
                
                return auth0Client;
            } catch (error) {
                console.error("‚ùå Error inicializando Auth0:", error);
                throw error;
            }
        };

        // Aplicaci√≥n principal
        class AdminApp {
            constructor() {
                this.auth0 = null;
                this.init();
            }

            async init() {
                try {
                    console.log("üöÄ Iniciando AdminApp...");
                    
                    // Inicializar Auth0
                    this.auth0 = await configureClient();
                    console.log("‚úÖ Auth0 inicializado en AdminApp");
                    
                    // Configurar eventos
                    this.setupEventListeners();
                    
                    // Manejar callback
                    await this.handleAuthenticationCallback();
                    
                    // Actualizar UI
                    await this.updateUI();
                    
                } catch (error) {
                    console.error("‚ùå Error en AdminApp.init:", error);
                    this.showError("Error al inicializar la aplicaci√≥n: " + error.message);
                }
            }

            setupEventListeners() {
                console.log("üîß Configurando event listeners...");
                
                // Bot√≥n de login
                const loginBtn = document.getElementById('login-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        console.log("üëÜ Bot√≥n de login clickeado");
                        this.login();
                    });
                }

                // Bot√≥n de logout
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        console.log("üëÜ Bot√≥n de logout clickeado");
                        this.logout();
                    });
                }
            }

            async handleAuthenticationCallback() {
                console.log("üîÑ Verificando callback...");
                
                if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
                    try {
                        console.log("üîÑ Procesando callback...");
                        await this.auth0.handleRedirectCallback();
                        window.history.replaceState({}, document.title, window.location.pathname);
                        console.log("‚úÖ Callback procesado");
                    } catch (error) {
                        console.error("‚ùå Error en callback:", error);
                    }
                }
            }

            async updateUI() {
                console.log("üé® Actualizando UI...");
                
                try {
                    const isAuthenticated = await this.auth0.isAuthenticated();
                    console.log("üîê Estado de autenticaci√≥n:", isAuthenticated);
                    
                    // Ocultar loading
                    document.getElementById('loading-section').classList.add('hidden');
                    
                    if (isAuthenticated) {
                        this.showAuthenticatedUI();
                    } else {
                        this.showLoginUI();
                    }
                } catch (error) {
                    console.error("‚ùå Error actualizando UI:", error);
                    this.showLoginUI();
                }
            }

            showAuthenticatedUI() {
                console.log("üë§ Mostrando UI autenticada");
                
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('user-controls').classList.remove('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                this.loadUserInfo();
            }

            showLoginUI() {
                console.log("üîì Mostrando UI de login");
                
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('user-controls').classList.add('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }

            showError(message) {
                document.getElementById('loading-section').classList.add('hidden');
                document.getElementById('error-message').textContent = message;
                document.getElementById('error-section').classList.remove('hidden');
            }

            async loadUserInfo() {
                try {
                    const user = await this.auth0.getUser();
                    console.log("üë§ Usuario:", user);
                    
                    document.getElementById('user-name').textContent = user.name || user.nickname || 'Usuario';
                    document.getElementById('user-email').textContent = user.email || 'No disponible';
                } catch (error) {
                    console.error("‚ùå Error cargando usuario:", error);
                }
            }

            async login() {
                try {
                    console.log("üîê Iniciando login...");
                    await this.auth0.loginWithRedirect();
                } catch (error) {
                    console.error("‚ùå Error en login:", error);
                }
            }

            async logout() {
                try {
                    console.log("üö™ Iniciando logout...");
                    await this.auth0.logout({
                        logoutParams: {
                            returnTo: window.location.origin
                        }
                    });
                } catch (error) {
                    console.error("‚ùå Error en logout:", error);
                }
            }
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üìÑ DOM cargado, iniciando AdminApp...");
            new AdminApp();
        });
    </script>
</body>
</html> 