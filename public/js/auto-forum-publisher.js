// Sistema Automatizado de Publicaci贸n en Foro
class AutoForumPublisher {
  constructor() {
    this.foroManager = window.foroManager;
    this.init();
  }

  init() {
    // Escuchar eventos de publicaci贸n de art铆culos
    this.setupArticleListeners();
    
    // Verificar si hay art铆culos nuevos que necesiten publicaci贸n en foro
    this.checkForNewArticles();
  }

  // Configurar listeners para detectar nuevas publicaciones de art铆culos
  setupArticleListeners() {
    // Escuchar cambios en el localStorage (simulaci贸n de nueva publicaci贸n)
    window.addEventListener('storage', (e) => {
      if (e.key === 'new_article_published') {
        const articleData = JSON.parse(e.newValue);
        if (articleData) {
          this.createForumPostFromArticle(articleData);
        }
      }
    });

    // Tambi茅n escuchar eventos personalizados
    document.addEventListener('articlePublished', (e) => {
      this.createForumPostFromArticle(e.detail);
    });
  }

  // Verificar art铆culos existentes que no tengan publicaci贸n en foro
  checkForNewArticles() {
    const publishedArticles = this.getPublishedArticles();
    const forumPosts = this.foroManager ? this.foroManager.posts : [];
    
    publishedArticles.forEach(article => {
      const hasForumPost = forumPosts.some(post => 
        post.articleId === article.id || 
        post.content.includes(article.title)
      );
      
      if (!hasForumPost) {
        this.createForumPostFromArticle(article);
      }
    });
  }

  // Obtener art铆culos publicados (simulado)
  getPublishedArticles() {
    // En un entorno real, esto vendr铆a de la API del blog
    const savedArticles = localStorage.getItem('published_articles');
    if (savedArticles) {
      return JSON.parse(savedArticles);
    }
    
    // Art铆culos de ejemplo basados en el contenido del blog
    return [
      {
        id: '2025-01-22-desarrollo-web-villa-carlos-paz',
        title: 'Desarrollo Web Profesional en Villa Carlos Paz: Potenciando Negocios Locales',
        description: 'Descubre c贸mo el desarrollo web profesional est谩 transformando los negocios en Villa Carlos Paz, C贸rdoba. Soluciones digitales a medida para empresas locales.',
        category: 'Desarrollo Web Local',
        tags: ['Villa Carlos Paz', 'Desarrollo Web', 'Marketing Digital', 'C贸rdoba', 'Negocios Locales', 'SEO Local'],
        image: '/logos-he-imagenes/programacion.jpeg',
        publishedAt: '2025-01-22',
        author: 'hgaruna'
      }
    ];
  }

  // Crear publicaci贸n en foro basada en art铆culo
  createForumPostFromArticle(article) {
    if (!this.foroManager) {
      console.error('ForoManager no est谩 disponible');
      return;
    }

    // Generar contenido para el foro
    const forumContent = this.generateForumContent(article);
    
    // Crear la publicaci贸n en el foro
    const forumPost = this.foroManager.createPost(
      forumContent,
      article.image,
      article.category
    );

    // Agregar metadatos del art铆culo
    forumPost.articleId = article.id;
    forumPost.articleTitle = article.title;
    forumPost.articleUrl = `/blog/${article.id}`;
    forumPost.tags = article.tags;
    forumPost.isAutoGenerated = true;

    // Guardar la publicaci贸n actualizada
    this.foroManager.savePosts();

    console.log(`Publicaci贸n autom谩tica creada en foro para: ${article.title}`);
    
    // Disparar evento para integraci贸n futura con LinkedIn
    this.triggerLinkedInIntegration(forumPost, article);
  }

  // Generar contenido para el foro basado en el art铆culo
  generateForumContent(article) {
    const content = `
 **隆Nuevo art铆culo publicado!** 

 **${article.title}**

${this.generateSummary(article.description)}

 **Lee el art铆culo completo:** [${article.title}](${article.articleUrl || `/blog/${article.id}`})

 **驴Qu茅 opinas sobre este tema?** Comparte tus experiencias y conocimientos en los comentarios.

#${article.tags.map(tag => tag.replace(/\s+/g, '')).join(' #')} #hgaruna #DesarrolloWeb
    `.trim();

    return content;
  }

  // Generar resumen del art铆culo
  generateSummary(description) {
    // Limitar a 200 caracteres y agregar puntos suspensivos si es necesario
    if (description.length <= 200) {
      return description;
    }
    
    return description.substring(0, 200).trim() + '...';
  }

  // Disparar evento para integraci贸n con LinkedIn (futuro)
  triggerLinkedInIntegration(forumPost, article) {
    const linkedInData = {
      forumPost: forumPost,
      article: article,
      timestamp: new Date().toISOString()
    };

    // Guardar datos para integraci贸n futura
    localStorage.setItem('linkedin_integration_queue', JSON.stringify(linkedInData));
    
    // Disparar evento personalizado
    document.dispatchEvent(new CustomEvent('linkedinIntegrationReady', {
      detail: linkedInData
    }));

    console.log('Datos preparados para integraci贸n con LinkedIn:', linkedInData);
  }

  // M茅todo para publicar manualmente un art铆culo en el foro
  manualPublishArticle(articleData) {
    this.createForumPostFromArticle(articleData);
  }

  // Obtener estad铆sticas de publicaciones autom谩ticas
  getAutoPublishStats() {
    const forumPosts = this.foroManager ? this.foroManager.posts : [];
    const autoPosts = forumPosts.filter(post => post.isAutoGenerated);
    
    return {
      totalAutoPosts: autoPosts.length,
      totalForumPosts: forumPosts.length,
      autoPostsPercentage: forumPosts.length > 0 ? (autoPosts.length / forumPosts.length * 100).toFixed(1) : 0
    };
  }
}

// Funci贸n para simular la publicaci贸n de un nuevo art铆culo
function simulateArticlePublication(articleData) {
  // Guardar en localStorage para simular nueva publicaci贸n
  localStorage.setItem('new_article_published', JSON.stringify(articleData));
  
  // Disparar evento personalizado
  document.dispatchEvent(new CustomEvent('articlePublished', {
    detail: articleData
  }));
}

// Funci贸n para publicar art铆culo manualmente desde el admin
function publishArticleToForum(articleData) {
  if (window.autoForumPublisher) {
    window.autoForumPublisher.manualPublishArticle(articleData);
    return true;
  }
  return false;
}

// Inicializar cuando el DOM est茅 listo
document.addEventListener('DOMContentLoaded', () => {
  // Esperar a que el ForoManager est茅 disponible
  const checkForoManager = setInterval(() => {
    if (window.foroManager) {
      clearInterval(checkForoManager);
      window.autoForumPublisher = new AutoForumPublisher();
      console.log('AutoForumPublisher inicializado');
    }
  }, 100);
});

// Exportar para uso global
window.AutoForumPublisher = AutoForumPublisher;
window.simulateArticlePublication = simulateArticlePublication;
window.publishArticleToForum = publishArticleToForum; 