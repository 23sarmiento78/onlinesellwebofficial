const fs = require('fs');
const path = require('path');
const matter = require('gray-matter');

// Funci√≥n para leer y parsear art√≠culos Markdown
function parseArticle(filePath) {
  const fileContent = fs.readFileSync(filePath, 'utf-8');
  const { data: frontmatter, content } = matter(fileContent);
  
  return {
    title: frontmatter.title,
    description: frontmatter.description,
    content: content,
    category: frontmatter.category || 'Desarrollo Web',
    author: frontmatter.author || 'hgaruna',
    image: frontmatter.image || '/logos-he-imagenes/programacion.jpeg',
    tags: frontmatter.tags || [],
    date: frontmatter.date,
    slug: path.basename(filePath, '.md'),
    published: true,
    _id: `article_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  };
}

// Funci√≥n para migrar art√≠culos
function migrateArticles() {
  const articlesDir = path.join(__dirname, '../src/content/articles');
  const articles = [];
  
  try {
    // Leer todos los archivos .md en el directorio de art√≠culos
    const files = fs.readdirSync(articlesDir).filter(file => file.endsWith('.md'));
    
    console.log(`üìù Encontrados ${files.length} art√≠culos para migrar...`);
    
    files.forEach((file, index) => {
      const filePath = path.join(articlesDir, file);
      const article = parseArticle(filePath);
      
      // Generar ID √∫nico basado en el timestamp del archivo
      const stats = fs.statSync(filePath);
      article._id = `article_${stats.mtime.getTime()}_${index}`;
      
      articles.push(article);
      console.log(`‚úÖ Migrado: ${article.title}`);
    });
    
    // Guardar en localStorage para el sistema de admin
    const articlesData = JSON.stringify(articles, null, 2);
    
    // Crear archivo de datos para el sistema
    const outputPath = path.join(__dirname, '../public/data/articles.json');
    fs.mkdirSync(path.dirname(outputPath), { recursive: true });
    fs.writeFileSync(outputPath, articlesData);
    
    console.log(`\nüéâ Migraci√≥n completada!`);
    console.log(`üìä Total de art√≠culos migrados: ${articles.length}`);
    console.log(`üíæ Datos guardados en: ${outputPath}`);
    
    // Mostrar resumen de art√≠culos
    console.log(`\nüìã Art√≠culos migrados:`);
    articles.forEach((article, index) => {
      console.log(`${index + 1}. ${article.title} (${article.date})`);
    });
    
    return articles;
    
  } catch (error) {
    console.error('‚ùå Error durante la migraci√≥n:', error);
    return [];
  }
}

// Funci√≥n para crear publicaciones autom√°ticas en el foro
function createForumPosts(articles) {
  const forumPosts = [];
  
  articles.forEach((article, index) => {
    const forumContent = `
üöÄ **¬°Art√≠culo migrado al nuevo sistema!** 

üìñ **${article.title}**

${article.description}

üîó **Lee el art√≠culo completo:** [${article.title}](/blog/${article.slug}/)

üìÖ **Publicado:** ${new Date(article.date).toLocaleDateString('es-ES')}
üë®‚Äçüíª **Autor:** ${article.author}

üí° **¬øQu√© opinas sobre este tema?** Comparte tus experiencias y conocimientos en los comentarios.

#${article.tags.map(tag => tag.replace(/\s+/g, '')).join(' #')} #hgaruna #DesarrolloWeb
    `.trim();

    const forumPost = {
      _id: `post_${Date.now()}_${index}`,
      content: forumContent,
      image: article.image,
      category: article.category,
      author: 'hgaruna',
      tags: article.tags,
      timestamp: article.date,
      likes: 0,
      comments: [],
      isAutoGenerated: true,
      articleId: article._id,
      articleTitle: article.title,
      articleUrl: `/blog/${article.slug}/`,
      articleAuthor: article.author,
      articlePublishedAt: article.date
    };
    
    forumPosts.push(forumPost);
  });
  
  // Guardar publicaciones del foro
  const forumData = JSON.stringify(forumPosts, null, 2);
  const forumOutputPath = path.join(__dirname, '../public/data/forum-posts.json');
  fs.writeFileSync(forumOutputPath, forumData);
  
  console.log(`\nüí¨ Creadas ${forumPosts.length} publicaciones autom√°ticas en el foro`);
  console.log(`üíæ Datos del foro guardados en: ${forumOutputPath}`);
  
  return forumPosts;
}

// Funci√≥n principal
function main() {
  console.log('üöÄ Iniciando migraci√≥n de art√≠culos...\n');
  
  // Migrar art√≠culos
  const articles = migrateArticles();
  
  if (articles.length > 0) {
    // Crear publicaciones del foro
    createForumPosts(articles);
    
    console.log('\n‚úÖ Migraci√≥n completada exitosamente!');
    console.log('\nüìù Pr√≥ximos pasos:');
    console.log('1. Los art√≠culos est√°n disponibles en el panel de administraci√≥n');
    console.log('2. Las publicaciones autom√°ticas se crearon en el foro');
    console.log('3. Puedes editar y gestionar todo desde el admin');
  } else {
    console.log('\n‚ùå No se pudieron migrar los art√≠culos');
  }
}

// Ejecutar si se llama directamente
if (require.main === module) {
  main();
}

module.exports = { migrateArticles, createForumPosts }; 